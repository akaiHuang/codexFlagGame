rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 驗證使用者已登入
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 驗證是資料擁有者
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // 驗證分數資料的合理性（傳入的資料）
    function isValidScoreData() {
      return request.resource.data.uid == request.auth.uid &&
             request.resource.data.bestStreak is int &&
             request.resource.data.accuracy is number &&
             request.resource.data.total is int &&
             request.resource.data.bestStreak >= 0 &&
             request.resource.data.bestStreak <= 1000 &&
             request.resource.data.accuracy >= 0 &&
             request.resource.data.accuracy <= 100 &&
             request.resource.data.total >= 0 &&
             request.resource.data.total <= 100000;
    }
    
    // profiles - 使用者名稱
    match /profiles/{userId} {
      // 🔓 公開讀取（排行榜需要顯示名稱）
      allow read: if true;
      
      // 🔒 僅限擁有者寫入，驗證資料
      allow write: if isOwner(userId) && 
        request.resource.data.uid == userId &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 50;
    }
    
    // scores - 全球排行榜
    match /scores/{userId} {
      // 🔓 公開讀取（任何人都能瀏覽排行榜）
      allow read: if true;
      
      // 🔒 僅限 Cloud Functions 寫入（完全防止客戶端作弊）
      allow write: if false;
    }
    
    // scores_region - 地區排行榜
    match /scores_region/{docId} {
      // 🔓 公開讀取（任何人都能瀏覽排行榜）
      allow read: if true;
      
      // 🔒 僅限 Cloud Functions 寫入（完全防止客戶端作弊）
      allow write: if false;
    }
    
    // users - 使用者統計資料（內部使用）
    match /users/{userId} {
      // 🔒 僅限擁有者讀取
      allow read: if isOwner(userId);
      
      // 🔒 僅限 Cloud Functions 寫入
      allow write: if false;
    }
    
    // 拒絕其他所有存取
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
