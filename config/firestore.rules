rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 驗證使用者已登入
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 驗證是資料擁有者
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // 驗證分數資料的合理性（傳入的資料）
    function isValidScoreData() {
      return request.resource.data.uid == request.auth.uid &&
             request.resource.data.bestStreak is int &&
             request.resource.data.accuracy is number &&
             request.resource.data.total is int &&
             request.resource.data.bestStreak >= 0 &&
             request.resource.data.bestStreak <= 1000 &&
             request.resource.data.accuracy >= 0 &&
             request.resource.data.accuracy <= 100 &&
             request.resource.data.total >= 0 &&
             request.resource.data.total <= 100000;
    }
    
    // profiles - 使用者名稱
    match /profiles/{userId} {
      // 🔓 公開讀取（排行榜需要顯示名稱）
      allow read: if true;
      
      // 🔒 僅限擁有者寫入，驗證資料
      allow write: if isOwner(userId) && 
        request.resource.data.uid == userId &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 50;
    }
    
    // scores - 全球排行榜
    match /scores/{userId} {
      // 🔓 公開讀取（任何人都能瀏覽排行榜）
      allow read: if true;
      
      // 🔒 僅限擁有者寫入，驗證資料
      allow write: if isOwner(userId) && isValidScoreData();
    }
    
    // scores_region - 地區排行榜
    match /scores_region/{userRegionId} {
      // 🔓 公開讀取（任何人都能瀏覽排行榜）
      allow read: if true;
      
      // 🔒 僅限擁有者寫入，驗證資料
      // userRegionId 格式: {uid}_{region}
      // region 可以是: global, asia, europe, africa, americas, oceania
      allow write: if isSignedIn() && 
        userRegionId.matches('^' + request.auth.uid + '_(global|asia|europe|africa|americas|oceania)$') &&
        isValidScoreData() &&
        request.resource.data.region is string &&
        request.resource.data.region.matches('^(global|asia|europe|africa|americas|oceania)$');
    }
    
    // 拒絕其他所有存取
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
