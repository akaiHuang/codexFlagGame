rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // é©—è­‰ä½¿ç”¨è€…å·²ç™»å…¥
    function isSignedIn() {
      return request.auth != null;
    }
    
    // é©—è­‰æ˜¯è³‡æ–™æ“æœ‰è€…
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // é˜²æ­¢é »ç¹å¯«å…¥ - profiles ä½¿ç”¨ updatedAt
    function notTooFrequentProfile() {
      return !resource.exists || 
             request.time > resource.data.updatedAt + duration.value(3, 's');
    }
    
    // é˜²æ­¢é »ç¹å¯«å…¥ - scores ä½¿ç”¨ ts
    function notTooFrequentScore() {
      return !resource.exists || 
             request.time > resource.data.ts + duration.value(3, 's');
    }
    
    // profiles - ä½¿ç”¨è€…åç¨±
    match /profiles/{userId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆæŽ’è¡Œæ¦œéœ€è¦é¡¯ç¤ºåç¨±ï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™æ“æœ‰è€…å¯«å…¥ï¼Œé™æµï¼Œé©—è­‰è³‡æ–™
      allow write: if isOwner(userId) && 
        notTooFrequentProfile() &&
        request.resource.data.uid == userId &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 50;
    }
    
    // scores - å…¨çƒæŽ’è¡Œæ¦œ
    match /scores/{userId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆä»»ä½•äººéƒ½èƒ½ç€è¦½æŽ’è¡Œæ¦œï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™æ“æœ‰è€…å¯«å…¥ï¼Œé™æµï¼Œé©—è­‰è³‡æ–™
      allow write: if isOwner(userId) && 
        notTooFrequentScore() &&
        request.resource.data.uid == userId &&
        request.resource.data.bestStreak is int &&
        request.resource.data.accuracy is number &&
        request.resource.data.total is int &&
        request.resource.data.bestStreak >= 0 &&
        request.resource.data.bestStreak <= 1000 &&
        request.resource.data.accuracy >= 0 &&
        request.resource.data.accuracy <= 100 &&
        request.resource.data.total >= 0 &&
        request.resource.data.total <= 100000;
    }
    
    // scores_region - åœ°å€æŽ’è¡Œæ¦œ
    match /scores_region/{userRegionId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆä»»ä½•äººéƒ½èƒ½ç€è¦½æŽ’è¡Œæ¦œï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™æ“æœ‰è€…å¯«å…¥ï¼Œé™æµï¼Œé©—è­‰è³‡æ–™
      allow write: if isSignedIn() && 
        notTooFrequentScore() &&
        userRegionId.matches('^' + request.auth.uid + '_[A-Z]{2}$') &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.bestStreak is int &&
        request.resource.data.accuracy is number &&
        request.resource.data.total is int &&
        request.resource.data.region is string &&
        request.resource.data.bestStreak >= 0 &&
        request.resource.data.bestStreak <= 1000 &&
        request.resource.data.accuracy >= 0 &&
        request.resource.data.accuracy <= 100 &&
        request.resource.data.total >= 0 &&
        request.resource.data.total <= 100000;
    }
    
    // æ‹’çµ•å…¶ä»–æ‰€æœ‰å­˜å–
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
