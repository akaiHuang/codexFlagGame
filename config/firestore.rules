rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // é©—è­‰ä½¿ç”¨è€…å·²ç™»å…¥
    function isSignedIn() {
      return request.auth != null;
    }
    
    // é©—è­‰æ˜¯è³‡æ–™æ“æœ‰è€…
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // é©—è­‰åˆ†æ•¸è³‡æ–™çš„åˆç†æ€§ï¼ˆå‚³å…¥çš„è³‡æ–™ï¼‰
    function isValidScoreData() {
      return request.resource.data.uid == request.auth.uid &&
             request.resource.data.bestStreak is int &&
             request.resource.data.accuracy is number &&
             request.resource.data.total is int &&
             request.resource.data.bestStreak >= 0 &&
             request.resource.data.bestStreak <= 1000 &&
             request.resource.data.accuracy >= 0 &&
             request.resource.data.accuracy <= 100 &&
             request.resource.data.total >= 0 &&
             request.resource.data.total <= 100000;
    }
    
    // profiles - ä½¿ç”¨è€…åç¨±
    match /profiles/{userId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆæŽ’è¡Œæ¦œéœ€è¦é¡¯ç¤ºåç¨±ï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™æ“æœ‰è€…å¯«å…¥ï¼Œé©—è­‰è³‡æ–™
      allow write: if isOwner(userId) && 
        request.resource.data.uid == userId &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 50;
    }
    
    // scores - å…¨çƒæŽ’è¡Œæ¦œ
    match /scores/{userId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆä»»ä½•äººéƒ½èƒ½ç€è¦½æŽ’è¡Œæ¦œï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™ Cloud Functions å¯«å…¥ï¼ˆå®Œå…¨é˜²æ­¢å®¢æˆ¶ç«¯ä½œå¼Šï¼‰
      allow write: if false;
    }
    
    // scores_region - åœ°å€æŽ’è¡Œæ¦œ
    match /scores_region/{docId} {
      // ðŸ”“ å…¬é–‹è®€å–ï¼ˆä»»ä½•äººéƒ½èƒ½ç€è¦½æŽ’è¡Œæ¦œï¼‰
      allow read: if true;
      
      // ðŸ”’ åƒ…é™ Cloud Functions å¯«å…¥ï¼ˆå®Œå…¨é˜²æ­¢å®¢æˆ¶ç«¯ä½œå¼Šï¼‰
      allow write: if false;
    }
    
    // users - ä½¿ç”¨è€…çµ±è¨ˆè³‡æ–™ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰
    match /users/{userId} {
      // ðŸ”’ åƒ…é™æ“æœ‰è€…è®€å–
      allow read: if isOwner(userId);
      
      // ðŸ”’ åƒ…é™ Cloud Functions å¯«å…¥
      allow write: if false;
    }
    
    // æ‹’çµ•å…¶ä»–æ‰€æœ‰å­˜å–
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
