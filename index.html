<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>世界國旗挑戰</title>
  <!-- Firebase 配置 - 從外部檔案載入 -->
  <script src="config/firebase.config.js"></script>
  <style>
    :root {
      --bg: #0f1220; --card: #161a2b; --text: #e7e9f7; --muted: #9aa1c3;
      --primary: #6ee7b7; --accent: #8ab4ff; --danger: #ff6b6b; --warn: #ffd166;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: linear-gradient(180deg,#0c0f1d,#121733 60%,#0f1220);
      color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height: 100svh; display: flex; flex-direction: column; align-items: center;
    }
    .wrap { width: min(720px, 100%); padding: env(safe-area-inset-top) 16px calc(12px + env(safe-area-inset-bottom)); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 4px; }
    h1 { margin:0; font-size:20px; letter-spacing:.5px }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    select, button, .pill {
      background: #1b2140; color: var(--text); border: 1px solid #2a315a; border-radius: 12px;
      padding: 10px 12px; font-size:14px;
    }
    button.primary { background: linear-gradient(135deg,#2a7f72,#26a69a); border: none; }
    button.ghost { background: #151a2f; }
    button:active { transform: scale(.98); }
    main { margin-top: 8px; }
    .card {
      background: radial-gradient(1200px 80% at 50% -10%,rgba(138,180,255,.06),transparent),
                  linear-gradient(0deg,rgba(110,231,183,.06),transparent 60%), var(--card);
      border: 1px solid #2a315a; border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position: relative; z-index: 1;
    }
    .flag-box {
      aspect-ratio: 4/3; border-radius: 12px; background: #0a0f24; border: 1px solid #2a315a;
      display:flex; align-items:center; justify-content:center; overflow:hidden; position: relative; z-index: 1;
    }
    .flag-box .flag { font-size: clamp(72px, 22vw, 140px); line-height:1; position: relative; z-index: 1; }
    .progress-badge {
      position: absolute; bottom: 12px; right: 12px; z-index: 10;
      background: rgba(10, 15, 36, 0.9); backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
    }
    .hint { color: var(--muted); font-size:13px; margin-top:6px; position: relative; z-index: 250; }
    .options { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:14px; }
    .opt {
      background: #131836; color: var(--text); border: 1px solid #2a315a; border-radius: 12px;
      padding: 12px; text-align:left; font-size:15px; line-height:1.25;
    }
    .opt.correct { border-color: #2dd4bf; background: #0f2a2a; }
    .opt.wrong { border-color: var(--danger); background: #2a1217; }
    .bar { display:flex; align-items:center; justify-content:space-between; margin-top:10px; color: var(--muted); font-size:13px }
    .stat { display:flex; gap:10px; align-items:center }
    .stat .pill { padding:6px 10px; border:1px solid #2a315a; background:#111735; border-radius:999px; }
    .shake { animation: shake .4s; }
    @keyframes shake { 10%, 90% { transform: translateX(-2px) } 20%, 80% { transform: translateX(3px) } 30%, 50%, 70% { transform: translateX(-6px) } 40%, 60% { transform: translateX(6px) } }
    .celebrate { animation: pulse .5s ease-out; }
    @keyframes pulse { 0%{ transform:scale(1)} 50%{ transform:scale(1.02)} 100%{ transform:scale(1)} }
    @media (prefers-reduced-motion: reduce) { .shake, .celebrate { animation: none !important; } }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 300; }
    .modal.show { display:flex; }
    .sheet { width:min(640px,100%); background:#0f132e; border:1px solid #2a315a; border-radius:16px; padding:16px; }
    .sheet h3 { margin:4px 0 10px }
    .table { font-size:14px; color:var(--muted); margin-top:8px; }
    .table .item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #243058; }
    canvas#fx { position: fixed; inset: 0; pointer-events: none; z-index: 200; }
    
    /* 首頁樣式 */
    #homePage {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #homePage.hidden { display: none; }
    
    /* 國旗背景動畫 */
    .flag-bg {
      position: absolute;
      inset: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      padding: 0;
      animation: scroll-left 80s linear infinite;
      width: 200%;
      overflow: hidden;
    }
    .flag-bg .flag-item {
      font-size: 160px;
      line-height: 0.7;
      flex-shrink: 0;
      opacity: 0.6;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    /* 半透明黑色 + 高斯模糊遮罩 */
    .home-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    
    /* 首頁內容 */
    .home-content {
      position: relative;
      text-align: center;
      padding: 40px 20px;
      max-width: 500px;
    }
    .home-title {
      font-size: clamp(32px, 8vw, 56px);
      font-weight: 700;
      margin: 0 0 20px;
      background: linear-gradient(135deg, #6ee7b7, #8ab4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 1px;
    }
    .home-subtitle {
      font-size: 18px;
      color: var(--muted);
      margin-bottom: 40px;
    }
    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .home-btn {
      width: 280px;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .home-btn:active { transform: scale(0.98); }
    .home-btn.primary {
      background: linear-gradient(135deg, #2a7f72, #26a69a);
      color: white;
      box-shadow: 0 8px 24px rgba(42, 127, 114, 0.3);
    }
    .home-btn.primary:hover {
      box-shadow: 0 12px 32px rgba(42, 127, 114, 0.4);
    }
    .home-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    .home-btn-subtitle {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    /* 語言切換器 */
    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      background: rgba(22, 26, 43, 0.8);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .lang-btn {
      font-size: 28px;
      cursor: pointer;
      opacity: 0.5;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 8px;
      background: transparent;
      border: none;
    }
    .lang-btn:hover {
      opacity: 0.8;
      transform: scale(1.1);
    }
    .lang-btn.active {
      opacity: 1;
      background: rgba(42, 127, 114, 0.3);
    }
    
    /* 遊戲頁面 */
    #gamePage.hidden { display: none; }
  </style>
</head>
<body>
  <!-- 首頁 -->
  <div id="homePage">
    <!-- 語言切換器 -->
    <div class="lang-switcher">
      <button class="lang-btn active" data-lang="zh-TW" title="繁體中文">🇹🇼</button>
      <button class="lang-btn" data-lang="zh-CN" title="简体中文">🇨🇳</button>
      <button class="lang-btn" data-lang="en" title="English">🇬🇧</button>
      <button class="lang-btn" data-lang="ja" title="日本語">🇯🇵</button>
    </div>
    
    <!-- 國旗背景 -->
    <div class="flag-bg">
      <span class="flag-item">🇯🇵</span>
      <span class="flag-item">🇰🇷</span>
      <span class="flag-item">🇨🇳</span>
      <span class="flag-item">🇺🇸</span>
      <span class="flag-item">🇬🇧</span>
      <span class="flag-item">🇫🇷</span>
      <span class="flag-item">🇩🇪</span>
      <span class="flag-item">🇮🇹</span>
      <span class="flag-item">🇪🇸</span>
      <span class="flag-item">🇷🇺</span>
      <span class="flag-item">🇧🇷</span>
      <span class="flag-item">🇲🇽</span>
      <span class="flag-item">🇦🇺</span>
      <span class="flag-item">🇨🇦</span>
      <span class="flag-item">🇮🇳</span>
      <span class="flag-item">🇹🇭</span>
      <span class="flag-item">🇻🇳</span>
      <span class="flag-item">🇵🇭</span>
      <span class="flag-item">🇮🇩</span>
      <span class="flag-item">🇸🇬</span>
      <!-- 複製一組實現無縫循環 -->
      <span class="flag-item">🇯🇵</span>
      <span class="flag-item">🇰🇷</span>
      <span class="flag-item">🇨🇳</span>
      <span class="flag-item">🇺🇸</span>
      <span class="flag-item">🇬🇧</span>
      <span class="flag-item">🇫🇷</span>
      <span class="flag-item">🇩🇪</span>
      <span class="flag-item">🇮🇹</span>
      <span class="flag-item">🇪🇸</span>
      <span class="flag-item">🇷🇺</span>
      <span class="flag-item">🇧🇷</span>
      <span class="flag-item">🇲🇽</span>
      <span class="flag-item">🇦🇺</span>
      <span class="flag-item">🇨🇦</span>
      <span class="flag-item">🇮🇳</span>
      <span class="flag-item">🇹🇭</span>
      <span class="flag-item">🇻🇳</span>
      <span class="flag-item">🇵🇭</span>
      <span class="flag-item">🇮🇩</span>
      <span class="flag-item">🇸🇬</span>
    </div>
    
    <!-- 半透明黑色 + 高斯模糊遮罩 -->
    <div class="home-overlay"></div>
    
    <!-- 首頁內容 -->
    <div class="home-content">
      <h1 class="home-title">世界國旗挑戰</h1>
      <p class="home-subtitle">測試你對世界各國國旗的認識</p>
      <div class="home-buttons">
        <button id="startWithLogin" class="home-btn primary">
          開始遊戲
          <div class="home-btn-subtitle">Login by Google</div>
        </button>
      </div>
    </div>
  </div>

  <!-- 遊戲頁面 -->
  <div id="gamePage" class="hidden">
  <div class="wrap">
    <header>
      <h1 id="gameTitle" style="cursor: pointer;">世界國旗挑戰</h1>
      <div class="controls">
        <select id="region" aria-label="選擇地區">
          <option value="global">全球</option>
          <option value="asia">亞洲</option>
          <option value="europe">歐洲</option>
          <option value="africa">非洲</option>
          <option value="americas">美洲</option>
          <option value="oceania">大洋洲</option>
        </select>
        <select id="difficulty" aria-label="選擇難度">
          <option value="easy">容易</option>
          <option value="normal" selected>普通</option>
          <option value="hard">困難</option>
        </select>
        <button id="mode" class="ghost" aria-label="切換遊戲模式">模式：一般</button>
        <button id="reset" class="ghost" aria-label="重置遊戲紀錄">重置紀錄</button>
        <span id="userLabel" class="pill" aria-label="當前使用者">訪客</span>
      </div>
    </header>

    <main>
      <div id="card" class="card">
        <div class="flag-box" id="flagBox" role="img" aria-label="當前國旗">
          <div id="flag" class="flag">🏳️‍🌈</div>
          <span class="progress-badge pill" aria-label="答對進度"><span data-i18n="answered">已答對</span> <b id="correctCount">0</b>/<b id="totalFlags">0</b></span>
        </div>
        <div class="hint" id="hint" aria-live="polite">請選出正確的國家名稱</div>
        <div class="options" id="options" role="group" aria-label="答案選項"></div>
        <div class="bar">
          <div class="stat">
            <span class="pill" aria-label="當前正確率"><span data-i18n="accuracy">正確率</span> <b id="acc">0%</b></span>
            <span class="pill" aria-label="當前連勝數"><span data-i18n="streak">連勝</span> <b id="streak">0</b></span>
            <span class="pill" aria-label="累積總題數"><span data-i18n="total">總題數</span> <b id="total">0</b></span>
          </div>
          <div class="row">
            <button id="next" class="primary" aria-label="進入下一題">下一題 ▶</button>
            <button id="stats" class="ghost" aria-label="查看統計資料">統計</button>
            <button id="board" class="ghost" aria-label="查看排行榜">排行榜</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <canvas id="fx"></canvas>

  <div id="statsModal" class="modal" role="dialog" aria-labelledby="statsTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="statsTitle" data-i18n="myStats">我的統計</h3>
        <button id="closeStats" class="ghost" aria-label="關閉統計視窗" data-i18n="close">關閉</button>
      </div>
      <div class="row" style="gap:12px">
        <div class="pill"><span data-i18n="accuracyRate">準確率</span> <b id="s_acc">0%</b></div>
        <div class="pill"><span data-i18n="bestStreak">最佳連勝</span> <b id="s_best">0</b></div>
        <div class="pill"><span data-i18n="totalQuestions">累計題數</span> <b id="s_total">0</b></div>
      </div>
      <div class="table" id="wrongList"></div>
    </div>
  </div>

  <div id="boardModal" class="modal" role="dialog" aria-labelledby="boardTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="boardTitle" data-i18n="leaderboardTitle">排行榜</h3>
        <button id="closeBoard" class="ghost" aria-label="關閉排行榜視窗" data-i18n="close">關閉</button>
      </div>
      <div class="table" id="boardList"></div>
    </div>
  </div>

  <div id="authModal" class="modal" role="dialog" aria-labelledby="authTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="authTitle" data-i18n="login">登入</h3>
        <button id="closeAuth" class="ghost" aria-label="關閉登入視窗" data-i18n="close">關閉</button>
      </div>
      <div class="row" style="flex-direction:column; align-items:stretch; gap:10px; margin-top:20px">
        <button id="googleLogin" class="primary" aria-label="使用 Google 帳號登入" data-i18n="googleLogin">使用 Google 登入</button>
        <button id="guestContinue" class="ghost" aria-label="以訪客身份繼續" data-i18n="guestContinue">以訪客繼續</button>
      </div>
      <div class="row" style="margin-top:12px">
        <input id="nickname" placeholder="暱稱（選填，僅供排行榜顯示）" maxlength="24" aria-label="輸入暱稱"
               style="padding:10px;border-radius:8px;border:1px solid #2a315a;background:#0f132e;color:#e7e9f7;width:100%" />
      </div>
    </div>
  </div>

  <script>
    // 頁面切換邏輯
    const homePage = document.getElementById('homePage');
    const gamePage = document.getElementById('gamePage');
    const startWithLogin = document.getElementById('startWithLogin');
    
    function showGame() {
      homePage.classList.add('hidden');
      gamePage.classList.remove('hidden');
    }
    
    function showHome() {
      gamePage.classList.add('hidden');
      homePage.classList.remove('hidden');
    }
    
    // 稍後會加入 gameTitle 的點擊事件
    
    // 語言代碼映射到 Intl.DisplayNames 支援的 locale
    const langToLocale = {
      'zh-TW': 'zh-Hant',
      'zh-CN': 'zh-Hans',
      'en': 'en',
      'ja': 'ja'
    };

    // 動態獲取國家名稱（根據當前語言）
    function getCountryName(code) {
      try {
        const locale = langToLocale[currentLang] || 'zh-Hant';
        const intl = new Intl.DisplayNames([locale], { type: 'region' });
        return intl.of(code) || code;
      } catch {
        return code;
      }
    }

    const R = { AS:'asia', EU:'europe', AF:'africa', AM:'americas', OC:'oceania' };
    const RAW = {
      asia: 'JP CN TW HK MO KR KP VN TH MY SG ID PH IN PK BD LK NP KH LA MM MN AE SA QA KW OM BH JO IL TR IR IQ SY LB',
      europe: 'FR DE IT ES PT NL BE LU IE GB NO SE FI DK IS PL CZ SK HU AT CH LI SI HR BA RS ME MK AL GR BG RO MD UA BY LT LV EE',
      africa: 'EG MA DZ TN LY ET KE UG TZ RW BI GH NG CI SN CM CD ZA NA BW ZM ZW AO MZ MG',
      americas: 'US CA MX CU DO HT JM PA CR NI SV GT HN CO VE PE EC BO PY UY AR CL BR',
      oceania: 'AU NZ PG FJ WS TO'
    };
    const COUNTRIES = Object.entries(RAW)
      .flatMap(([region, s]) => s.split(' ').map(code => ({ code, region })));

    function codeToFlagEmoji(code) {
      return code.toUpperCase().replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt()));
    }
    const rand = (n) => Math.floor(Math.random() * n);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=rand(i+1); [a[i],a[j]]=[a[j],a[i]] } return a; }

    const store = {
      get(){ try { return JSON.parse(localStorage.getItem('fg_stats')||'{}') } catch { return {} } },
      set(d){ localStorage.setItem('fg_stats', JSON.stringify(d)) },
      reset(){ localStorage.removeItem('fg_stats') }
    };
    function ensureStats() {
      const s = store.get();
      s.total ??= 0; s.correct ??= 0; s.streak ??= 0; s.bestStreak ??= 0; s.by ??= {}; s.correctFlags ??= [];
      store.set(s); return s;
    }

    async function saveProfileName(ctx, uid, name) {
      if (!name) return;
      try {
        const now = ctx.serverTimestamp();
        await ctx.setDoc(ctx.doc(ctx.db, 'profiles', uid), {
          uid,
          name,
          createdAt: now,
          updatedAt: now
        }, { merge: true });
      } catch (error) {
        console.error('儲存使用者名稱失敗:', error);
        showNotification('無法儲存使用者資料，請稍後再試', 'error');
      }
    }

    async function augmentWithNames(ctx, rows) {
      const uids = [...new Set(rows.map(r => r.uid).filter(Boolean))];
      if (!uids.length) return rows;
      try {
        const entries = await Promise.all(uids.map(async (uid) => {
          try {
            const snap = await ctx.getDoc(ctx.doc(ctx.db, 'profiles', uid));
            return [uid, snap.exists() ? (snap.data().name || '') : ''];
          } catch (error) {
            console.error(`取得使用者 ${uid} 資料失敗:`, error);
            return [uid, ''];
          }
        }));
        const nameMap = Object.fromEntries(entries);
        return rows.map(r => ({ ...r, name: nameMap[r.uid] || '' }));
      } catch (error) {
        console.error('處理使用者名稱失敗:', error);
        return rows;
      }
    }

    function showAuth(show = true) {
      els.authModal.classList[show ? 'add' : 'remove']('show');
      if (show) {
        els.authModal.setAttribute('aria-hidden', 'false');
        els.nicknameInput.focus();
      } else {
        els.authModal.setAttribute('aria-hidden', 'true');
      }
    }

    function showNotification(message, type = 'info') {
      // 簡單的通知系統，可以進一步擴充
      els.hint.textContent = message;
      if (type === 'error') {
        console.error(message);
      }
    }

    function labelForUser(user) {
      if (!user) return '訪客';
      if (user.isAnonymous) return '訪客';
      if (user.displayName) return user.displayName;
      if (user.email) return user.email.split('@')[0];
      return user.uid.slice(-6);
    }

    function bindAuthUI(ctx) {
      const {
        auth,
        signInAnonymously,
        signOut,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged
      } = ctx;

      let initial = true;
      onAuthStateChanged(auth, async (user) => {
        if (initial && !user) {
          initial = false;
          return; // 不自動匿名登入，等待使用者選擇
        }
        initial = false;
        els.userLabel.textContent = labelForUser(user);
        const loggedIn = !!user && !user.isAnonymous;
        if (loggedIn) {
          const nickname = els.nicknameInput.value.trim();
          if (nickname) await saveProfileName(ctx, user.uid, nickname);
        }
        showAuth(false);
      });

      // 首頁按鈕
      startWithLogin.onclick = () => {
        showGame();
        showAuth(true); // 顯示登入視窗
      };
      
      // 語言切換按鈕
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.onclick = () => switchLanguage(btn.dataset.lang);
      });
      
      // 初始化語言
      switchLanguage(currentLang);
      
      // 遊戲標題點擊返回首頁
      els.gameTitle.onclick = () => showHome();

      els.closeAuth.onclick = () => showAuth(false);
      els.guestContinue.onclick = async () => {
        if (!auth.currentUser || !auth.currentUser.isAnonymous) {
          await signInAnonymously(auth).catch(err => showNotification(`匿名登入失敗：${err.message}`, 'error'));
        }
        showAuth(false);
      };
      els.googleLogin.onclick = async () => {
        const provider = new GoogleAuthProvider();
        try {
          const cred = await signInWithPopup(auth, provider);
          const nickname = (els.nicknameInput.value.trim() || cred.user.displayName || '').slice(0, 24);
          if (nickname) await saveProfileName(ctx, cred.user.uid, nickname);
        } catch (err) {
          console.error('Google 登入失敗:', err);
          showNotification(`登入失敗：${err.message}`, 'error');
        }
      };
    }

    function weightFor(code, mode) {
      const s = store.get(); const c = (s.by?.[code]) || {};
      const seen = c.seen || 0, wrong = c.wrong || 0, streak = c.streak || 0, score = c.score ?? 0;
      let w = 1 + wrong*2 + Math.max(0, 3 - streak) - Math.min(score, 2)*0.5;
      if (seen < 2) w += 0.4;
      if (mode === 'train') w *= 1.6;
      return Math.max(0.2, w);
    }
    function weightedPick(items, wfn) {
      const weights = items.map(wfn);
      const sum = weights.reduce((a,b)=>a+b,0) || items.length;
      let r = Math.random() * sum;
      for (let i=0;i<items.length;i++){ if ((r -= weights[i]) <= 0) return items[i]; }
      return items[items.length-1];
    }
    function getPool(region) {
      return region==='global' ? COUNTRIES.slice() : COUNTRIES.filter(c => c.region === region);
    }
    function fillTo(a, need, supply, excludeSet) {
      for (const x of supply) { if (a.length >= need) break; if (!excludeSet.has(x.code)) a.push(x); }
      return a;
    }
    function getDecoys(pool, correct, difficulty) {
      const exclude = new Set([correct.code]);
      let primary, fallback;
      if (difficulty === 'easy') {
        primary = pool.filter(c => c.region !== correct.region && c.code !== correct.code);
        fallback = pool.filter(c => c.code !== correct.code);
      } else if (difficulty === 'hard') {
        primary = pool.filter(c => c.region === correct.region && c.code !== correct.code);
        fallback = pool.filter(c => c.code !== correct.code);
      } else {
        primary = pool.filter(c => c.code !== correct.code);
        fallback = primary;
      }
      let picks = shuffle(primary).slice(0, 3);
      if (picks.length < 3) picks = fillTo(picks, 3, shuffle(fallback), exclude);
      return picks;
    }

    let current = null;
    let lock = false;
    let mode = 'normal';

    const els = {
      gameTitle: document.getElementById('gameTitle'),
      region: document.getElementById('region'),
      difficulty: document.getElementById('difficulty'),
      mode: document.getElementById('mode'),
      reset: document.getElementById('reset'),
      flag: document.getElementById('flag'),
      flagBox: document.getElementById('flagBox'),
      options: document.getElementById('options'),
      hint: document.getElementById('hint'),
      next: document.getElementById('next'),
      acc: document.getElementById('acc'),
      streak: document.getElementById('streak'),
      total: document.getElementById('total'),
      correctCount: document.getElementById('correctCount'),
      totalFlags: document.getElementById('totalFlags'),
      stats: document.getElementById('stats'),
      board: document.getElementById('board'),
      statsModal: document.getElementById('statsModal'),
      closeStats: document.getElementById('closeStats'),
      s_acc: document.getElementById('s_acc'),
      s_best: document.getElementById('s_best'),
      s_total: document.getElementById('s_total'),
      wrongList: document.getElementById('wrongList'),
      card: document.getElementById('card'),
      fx: document.getElementById('fx'),
      boardModal: document.getElementById('boardModal'),
      closeBoard: document.getElementById('closeBoard'),
      boardList: document.getElementById('boardList'),
      userLabel: document.getElementById('userLabel'),
      authModal: document.getElementById('authModal'),
      closeAuth: document.getElementById('closeAuth'),
      googleLogin: document.getElementById('googleLogin'),
      guestContinue: document.getElementById('guestContinue'),
      nicknameInput: document.getElementById('nickname')
    };

    const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
    const ctx = els.fx.getContext('2d');
    let particles = [];
    function resizeCanvas(){ els.fx.width = innerWidth; els.fx.height = innerHeight; }
    addEventListener('resize', resizeCanvas, {passive:true}); resizeCanvas();
    function spawnConfetti(amount=60) {
      if (prefersReduced) return;
      const colors = ['#6ee7b7','#8ab4ff','#ffd166','#ff6b6b','#c084fc','#f472b6'];
      const rect = els.flagBox.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const top = rect.top;
      for (let i=0;i<amount;i++){
        particles.push({
          x: cx + (Math.random() - .5) * rect.width * 0.6,
          y: top - 10 + Math.random()*10,
          vx: (Math.random() - .5) * 4,
          vy: 2 + Math.random() * 3,
          g: .08 + Math.random() * .08,
          a: 1, r: 2 + Math.random() * 3,
          c: colors[rand(colors.length)], ttl: 90 + rand(40)
        });
      }
    }
    function tick() {
      ctx.clearRect(0,0,els.fx.width,els.fx.height);
      
      // 如果沒有粒子，停止動畫循環以節省效能
      if (particles.length === 0) {
        requestAnimationFrame(tick);
        return;
      }
      
      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.ttl--;
        p.a = Math.max(0, p.ttl/120);
        ctx.globalAlpha = p.a; ctx.fillStyle = p.c;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        if (p.ttl <= 0 || p.y > innerHeight+20) particles.splice(i,1);
      }
      requestAnimationFrame(tick);
    }
    tick();

    function vibrate(pattern){ if (navigator.vibrate) try { navigator.vibrate(pattern) } catch {} }

    function updateHUD() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      els.acc.textContent = acc + '%';
      els.streak.textContent = s.streak || 0;
      els.total.textContent = s.total || 0;
      
      // 計算當前地區的國旗總數
      const regionVal = els.region.value;
      let totalFlagsInRegion = 0;
      if (regionVal === 'global') {
        totalFlagsInRegion = COUNTRIES.length;
      } else {
        totalFlagsInRegion = COUNTRIES.filter(c => c.region === regionVal).length;
      }
      
      // 計算當前地區已答對的國旗數
      const correctFlags = s.correctFlags || [];
      const correctInRegion = regionVal === 'global' 
        ? correctFlags.length
        : correctFlags.filter(code => {
            const country = COUNTRIES.find(c => c.code === code);
            return country && country.region === regionVal;
          }).length;
      
      els.correctCount.textContent = correctInRegion;
      els.totalFlags.textContent = totalFlagsInRegion;
    }

    function updateStatsModal() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      els.s_acc.textContent = acc + '%';
      els.s_best.textContent = s.bestStreak || 0;
      els.s_total.textContent = s.total || 0;
      const items = Object.entries(s.by || {})
        .map(([code, v]) => ({ code, wrong: v.wrong||0, seen: v.seen||0 }))
        .filter(x => x.wrong > 0)
        .sort((a,b)=> (b.wrong/(b.seen||1)) - (a.wrong/(a.seen||1)))
        .slice(0, 12);
      els.wrongList.innerHTML = items.length ? items.map(it => {
        const name = getCountryName(it.code);
        const rate = it.seen ? Math.round((1 - it.wrong/it.seen)*100) : 0;
        return `<div class="item"><span>${codeToFlagEmoji(it.code)} ${name}</span><span>錯 ${it.wrong}｜正確率 ${rate}%</span></div>`;
      }).join('') : '<div class="item">目前沒有錯題紀錄</div>';
    }

    function pickQuestion() {
      const region = els.region.value;
      const pool = getPool(region);
      let candidates = pool;
      if (mode === 'train') {
        const s = store.get();
        const wrongOnes = pool.filter(c => (s.by?.[c.code]?.wrong || 0) > 0);
        if (wrongOnes.length) candidates = wrongOnes;
      }
      const correct = weightedPick(candidates, c => weightFor(c.code, mode));
      const decoys = getDecoys(pool, correct, els.difficulty.value);
      const options = shuffle([correct, ...decoys]).map(x => x.code);
      return { correct: correct.code, options, region };
    }

    function renderQuestion() {
      current = pickQuestion();
      els.flag.textContent = codeToFlagEmoji(current.correct);
      els.hint.textContent = t('hint');
      els.options.innerHTML = '';
      els.card.classList.remove('shake','celebrate');
      
      // 更新 aria-label 讓螢幕閱讀器知道旗幟已更新
      els.flagBox.setAttribute('aria-label', `國旗：${getCountryName(current.correct)}`);
      
      const frag = document.createDocumentFragment();
      current.options.forEach((optCode, index) => {
        const btn = document.createElement('button');
        btn.className = 'opt';
        btn.dataset.code = optCode;
        btn.textContent = getCountryName(optCode);
        btn.setAttribute('aria-label', `選項 ${index + 1}：${getCountryName(optCode)}`);
        btn.onclick = () => answer(optCode);
        frag.appendChild(btn);
      });
      els.options.appendChild(frag);
    }

    function answer(chosen) {
      if (lock) return;
      lock = true;
      const s = ensureStats();
      s.total = (s.total || 0) + 1;
      const correct = chosen === current.correct;
      [...els.options.children].forEach(b => {
        const code = b.dataset.code;
        if (code === current.correct) b.classList.add('correct');
        if (code === chosen && !correct) b.classList.add('wrong');
        b.disabled = true;
      });
      const cc = current.correct;
      s.by[cc] ??= { seen:0, wrong:0, streak:0, score:0 };
      const cs = s.by[cc];
      cs.seen += 1;
      if (correct) {
        s.correct = (s.correct || 0) + 1;
        s.streak = (s.streak || 0) + 1;
        s.bestStreak = Math.max(s.bestStreak || 0, s.streak);
        cs.streak = (cs.streak || 0) + 1;
        cs.score = (cs.score ?? 0) + 1;
        // 記錄答對的國旗
        s.correctFlags = s.correctFlags || [];
        if (!s.correctFlags.includes(cc)) {
          s.correctFlags.push(cc);
        }
        els.card.classList.add('celebrate');
        spawnConfetti(70 + Math.min(60, (s.streak||0) * 5));
        vibrate(30);
        els.hint.textContent = t('correct');
      } else {
        s.streak = 0;
        cs.wrong = (cs.wrong || 0) + 1;
        cs.streak = 0;
        cs.score = Math.max(0, (cs.score ?? 0) - 1);
        els.card.classList.add('shake');
        vibrate([20, 80, 20]);
        els.hint.textContent = t('wrong') + getCountryName(cc);
      }
      store.set(s);
      updateHUD();
    }

    function nextQuestion() { lock = false; renderQuestion(); }

    els.next.onclick = () => nextQuestion();
    els.region.onchange = () => { nextQuestion(); updateHUD(); };
    els.difficulty.onchange = () => nextQuestion();
    els.reset.onclick = () => {
      if (confirm('確定要重置本機紀錄嗎？')) { store.reset(); ensureStats(); updateHUD(); nextQuestion(); }
    };
    els.stats.onclick = () => { updateStatsModal(); els.statsModal.classList.add('show'); };
    els.closeStats.onclick = () => els.statsModal.classList.remove('show');
    els.mode.onclick = () => {
      mode = (mode === 'normal') ? 'train' : 'normal';
      els.mode.textContent = '模式：' + (mode === 'normal' ? '一般' : '訓練');
      nextQuestion();
    };

    const REGION_LABEL = {
      global: '全球',
      asia: '亞洲',
      europe: '歐洲',
      africa: '非洲',
      americas: '美洲',
      oceania: '大洋洲'
    };

    // 多語系字典
    const i18n = {
      'zh-TW': {
        homeTitle: '世界國旗挑戰',
        homeSubtitle: '測試你對世界各國國旗的認識',
        startGame: '開始遊戲',
        loginByGoogle: 'Login by Google',
        gameTitle: '世界國旗挑戰',
        selectRegion: '選擇地區',
        selectDifficulty: '選擇難度',
        mode: '模式：',
        modeNormal: '一般',
        modeTime: '計時',
        resetRecord: '重置紀錄',
        guest: '訪客',
        hint: '請選出正確的國家名稱',
        nextQuestion: '下一題 ▶',
        statistics: '統計',
        leaderboard: '排行榜',
        accuracy: '正確率',
        streak: '連勝',
        total: '總題數',
        answered: '已答對',
        easy: '容易',
        normal: '普通',
        hard: '困難',
        global: '全球',
        asia: '亞洲',
        europe: '歐洲',
        africa: '非洲',
        americas: '美洲',
        oceania: '大洋洲',
        // 彈窗相關
        close: '關閉',
        login: '登入',
        googleLogin: '使用 Google 登入',
        guestContinue: '以訪客繼續',
        nicknamePlaceholder: '暱稱（選填，僅供排行榜顯示）',
        myStats: '我的統計',
        accuracyRate: '準確率',
        bestStreak: '最佳連勝',
        totalQuestions: '累計題數',
        wrongAnswers: '答錯記錄',
        leaderboardTitle: '排行榜',
        // 遊戲訊息
        correct: '正確！',
        wrong: '答錯啦，正解：'
      },
      'zh-CN': {
        homeTitle: '世界国旗挑战',
        homeSubtitle: '测试你对世界各国国旗的认识',
        startGame: '开始游戏',
        loginByGoogle: 'Login by Google',
        gameTitle: '世界国旗挑战',
        selectRegion: '选择地区',
        selectDifficulty: '选择难度',
        mode: '模式：',
        modeNormal: '一般',
        modeTime: '计时',
        resetRecord: '重置记录',
        guest: '访客',
        hint: '请选出正确的国家名称',
        nextQuestion: '下一题 ▶',
        statistics: '统计',
        leaderboard: '排行榜',
        accuracy: '正确率',
        streak: '连胜',
        total: '总题数',
        answered: '已答对',
        easy: '容易',
        normal: '普通',
        hard: '困难',
        global: '全球',
        asia: '亚洲',
        europe: '欧洲',
        africa: '非洲',
        americas: '美洲',
        oceania: '大洋洲',
        // 彈窗相關
        close: '关闭',
        login: '登入',
        googleLogin: '使用 Google 登入',
        guestContinue: '以访客继续',
        nicknamePlaceholder: '昵称（选填，仅供排行榜显示）',
        myStats: '我的统计',
        accuracyRate: '准确率',
        bestStreak: '最佳连胜',
        totalQuestions: '累计题数',
        wrongAnswers: '答错记录',
        leaderboardTitle: '排行榜',
        // 遊戲訊息
        correct: '正确！',
        wrong: '答错了，正解：'
      },
      'en': {
        homeTitle: 'World Flag Challenge',
        homeSubtitle: 'Test your knowledge of world flags',
        startGame: 'Start Game',
        loginByGoogle: 'Login by Google',
        gameTitle: 'World Flag Challenge',
        selectRegion: 'Select Region',
        selectDifficulty: 'Select Difficulty',
        mode: 'Mode: ',
        modeNormal: 'Normal',
        modeTime: 'Timed',
        resetRecord: 'Reset Record',
        guest: 'Guest',
        hint: 'Select the correct country name',
        nextQuestion: 'Next ▶',
        statistics: 'Statistics',
        leaderboard: 'Leaderboard',
        accuracy: 'Accuracy',
        streak: 'Streak',
        total: 'Total',
        answered: 'Answered',
        easy: 'Easy',
        normal: 'Normal',
        hard: 'Hard',
        global: 'Global',
        asia: 'Asia',
        europe: 'Europe',
        africa: 'Africa',
        americas: 'Americas',
        oceania: 'Oceania',
        // Modal related
        close: 'Close',
        login: 'Login',
        googleLogin: 'Sign in with Google',
        guestContinue: 'Continue as Guest',
        nicknamePlaceholder: 'Nickname (optional, for leaderboard)',
        myStats: 'My Statistics',
        accuracyRate: 'Accuracy',
        bestStreak: 'Best Streak',
        totalQuestions: 'Total Questions',
        wrongAnswers: 'Wrong Answers',
        leaderboardTitle: 'Leaderboard',
        // Game messages
        correct: 'Correct!',
        wrong: 'Wrong! Answer: '
      },
      'ja': {
        homeTitle: '世界の国旗チャレンジ',
        homeSubtitle: '世界各国の国旗の知識をテスト',
        startGame: 'ゲーム開始',
        loginByGoogle: 'Login by Google',
        gameTitle: '世界の国旗チャレンジ',
        selectRegion: '地域を選択',
        selectDifficulty: '難易度を選択',
        mode: 'モード：',
        modeNormal: '通常',
        modeTime: 'タイム',
        resetRecord: '記録をリセット',
        guest: 'ゲスト',
        hint: '正しい国名を選択してください',
        nextQuestion: '次へ ▶',
        statistics: '統計',
        leaderboard: 'ランキング',
        accuracy: '正解率',
        streak: '連勝',
        total: '総問題数',
        answered: '正解数',
        easy: '簡単',
        normal: '普通',
        hard: '難しい',
        global: 'グローバル',
        asia: 'アジア',
        europe: 'ヨーロッパ',
        africa: 'アフリカ',
        americas: 'アメリカ大陸',
        oceania: 'オセアニア',
        // モーダル関連
        close: '閉じる',
        login: 'ログイン',
        googleLogin: 'Googleでログイン',
        guestContinue: 'ゲストとして続ける',
        nicknamePlaceholder: 'ニックネーム（任意、ランキング用）',
        myStats: 'マイ統計',
        accuracyRate: '正解率',
        bestStreak: '最高連勝',
        totalQuestions: '総問題数',
        wrongAnswers: '間違えた問題',
        leaderboardTitle: 'ランキング',
        // ゲームメッセージ
        correct: '正解！',
        wrong: '不正解！正解：'
      }
    };

    // 當前語言
    let currentLang = localStorage.getItem('language') || 'zh-TW';

    // 切換語言函數
    function switchLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('language', lang);
      updateUI();
      
      // 更新按鈕狀態
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // 如果當前有題目顯示，重新渲染以更新國家名稱
      if (current && !gamePage.classList.contains('hidden')) {
        // 重新渲染選項按鈕的文字
        const optionButtons = els.options.querySelectorAll('.opt');
        optionButtons.forEach(btn => {
          const code = btn.dataset.code;
          btn.textContent = getCountryName(code);
          const index = Array.from(optionButtons).indexOf(btn);
          btn.setAttribute('aria-label', `選項 ${index + 1}：${getCountryName(code)}`);
        });
        
        // 更新國旗的 aria-label
        els.flagBox.setAttribute('aria-label', `國旗：${getCountryName(current.correct)}`);
      }
    }

    // 獲取翻譯文字
    function t(key) {
      return i18n[currentLang]?.[key] || i18n['zh-TW'][key] || key;
    }

    // 更新 UI 文字
    function updateUI() {
      // 首頁
      const homeTitle = document.querySelector('.home-title');
      const homeSubtitle = document.querySelector('.home-subtitle');
      const startBtn = document.querySelector('#startWithLogin');
      const loginSubtitle = startBtn?.querySelector('.home-btn-subtitle');
      
      if (homeTitle) homeTitle.textContent = t('homeTitle');
      if (homeSubtitle) homeSubtitle.textContent = t('homeSubtitle');
      if (startBtn) {
        startBtn.childNodes[0].textContent = t('startGame') + ' ';
      }
      if (loginSubtitle) loginSubtitle.textContent = t('loginByGoogle');
      
      // 遊戲頁面
      const gameTitle = document.querySelector('#gameTitle');
      const hint = document.querySelector('#hint');
      const nextBtn = document.querySelector('#next');
      const statsBtn = document.querySelector('#stats');
      const boardBtn = document.querySelector('#board');
      const modeBtn = document.querySelector('#mode');
      const resetBtn = document.querySelector('#reset');
      
      if (gameTitle) gameTitle.textContent = t('gameTitle');
      if (hint) hint.textContent = t('hint');
      if (nextBtn) nextBtn.textContent = t('nextQuestion');
      if (statsBtn) statsBtn.textContent = t('statistics');
      if (boardBtn) boardBtn.textContent = t('leaderboard');
      if (resetBtn) resetBtn.textContent = t('resetRecord');
      
      // 更新模式按鈕
      if (modeBtn) {
        const isTimeMode = store.mode === 'time';
        modeBtn.textContent = t('mode') + (isTimeMode ? t('modeTime') : t('modeNormal'));
      }
      
      // 更新地區和難度選項
      const regionSelect = document.querySelector('#region');
      if (regionSelect) {
        Array.from(regionSelect.options).forEach(opt => {
          const key = opt.value;
          opt.textContent = t(key);
        });
      }
      
      const difficultySelect = document.querySelector('#difficulty');
      if (difficultySelect) {
        Array.from(difficultySelect.options).forEach(opt => {
          const key = opt.value;
          opt.textContent = t(key);
        });
      }
      
      // 更新所有帶有 data-i18n 屬性的元素
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // 更新 placeholder
      const nicknameInput = document.querySelector('#nickname');
      if (nicknameInput) {
        nicknameInput.placeholder = t('nicknamePlaceholder');
      }
    }

    const firebaseConfig = window.__FLAG_APP_FIREBASE__ || {
      apiKey: '',
      authDomain: '',
      projectId: '',
      storageBucket: '',
      messagingSenderId: '',
      appId: '',
      measurementId: ''
    };
    let fbInit;
    function readyConfig(cfg){ return cfg.apiKey && cfg.projectId && cfg.appId && cfg.authDomain; }

    async function ensureFirebase() {
      if (!readyConfig(firebaseConfig)) {
        alert('尚未設定 Firebase Config，請先填入 apiKey / authDomain / projectId / appId。');
        throw new Error('missing firebaseConfig');
      }
      if (!fbInit) {
        fbInit = (async () => {
          const [
            { initializeApp },
            {
              getAuth,
              onAuthStateChanged,
              signInAnonymously,
              signInWithPopup,
              GoogleAuthProvider,
              signOut
            },
            {
              getFirestore,
              collection,
              doc,
              setDoc,
              getDoc,
              serverTimestamp,
              query,
              orderBy,
              where,
              limit,
              getDocs
            }
          ] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js')
          ]);
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const db = getFirestore(app);
          if (location.protocol === 'https:' && firebaseConfig.measurementId) {
            try {
              const { getAnalytics, isSupported } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js');
              if (await isSupported()) getAnalytics(app);
            } catch (err) {
              console.warn('analytics init skipped', err);
            }
          }
          return {
            app,
            db,
            auth,
            onAuthStateChanged,
            signInAnonymously,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            collection,
            doc,
            setDoc,
            getDoc,
            serverTimestamp,
            query,
            orderBy,
            where,
            limit,
            getDocs
          };
        })();
      }
      return fbInit;
    }

    async function submitScore() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      const ctx = await ensureFirebase();
      let user = ctx.auth.currentUser;
      if (!user) {
        try {
          await ctx.signInAnonymously(ctx.auth);
          user = ctx.auth.currentUser;
        } catch (err) {
          console.error('無法取得認證使用者', err);
          return;
        }
      }
      const uid = user?.uid;
      if (!uid) return;
      const region = els.region.value;
      const scoreData = {
        uid,
        bestStreak: s.bestStreak || 0,
        accuracy: acc,
        total: s.total || 0,
        region,
        ts: ctx.serverTimestamp()
      };
      await ctx.setDoc(ctx.doc(ctx.db, 'scores', uid), scoreData, { merge: true });
      await ctx.setDoc(ctx.doc(ctx.db, 'scores_region', `${uid}_${region}`), scoreData, { merge: true });
    }

    function renderBoard(globalRows, regionRows, regionKey) {
      const toRow = (row, idx) => {
        const place = idx + 1;
        const name = row.name || (row.uid?.slice(-6) || 'Player');
        return `<div class="item"><span>${place}. ${name}</span><span>連勝 ${row.bestStreak || 0}｜準確率 ${row.accuracy || 0}%｜題數 ${row.total || 0}</span></div>`;
      };
      const globalSection = globalRows.length
        ? globalRows.map(toRow).join('')
        : '<div class="item">目前沒有資料</div>';
      const regionLabel = REGION_LABEL[regionKey] || '目前區域';
      const regionSection = regionRows.length
        ? regionRows.map(toRow).join('')
        : '<div class="item">目前沒有資料</div>';
      els.boardList.innerHTML = `
        <div class="item"><strong>全球榜</strong></div>
        ${globalSection}
        <div class="item"><strong>${regionLabel}榜</strong></div>
        ${regionSection}
      `;
    }

    async function openLeaderboard() {
      try {
        const ctx = await ensureFirebase();
        const { db, collection, query, orderBy, where, limit, getDocs } = ctx;
        els.boardList.innerHTML = '<div class="item">載入中...</div>';
        els.boardModal.classList.add('show');
        await submitScore();
        const region = els.region.value;
        const globalQ = query(collection(db, 'scores'), orderBy('bestStreak', 'desc'), limit(50));
        const regionQ = query(
          collection(db, 'scores_region'),
          where('region', '==', region),
          orderBy('bestStreak', 'desc'),
          limit(50)
        );
        const [globalSnap, regionSnap] = await Promise.all([getDocs(globalQ), getDocs(regionQ)]);
        const [globalRows, regionRows] = await Promise.all([
          augmentWithNames(ctx, globalSnap.docs.map(d => d.data())),
          augmentWithNames(ctx, regionSnap.docs.map(d => d.data()))
        ]);
        const sorter = (a, b) => {
          if ((b.bestStreak || 0) !== (a.bestStreak || 0)) return (b.bestStreak || 0) - (a.bestStreak || 0);
          return (b.accuracy || 0) - (a.accuracy || 0);
        };
        renderBoard(
          globalRows.sort(sorter).slice(0, 20),
          regionRows.sort(sorter).slice(0, 20),
          region
        );
      } catch (err) {
        console.error('載入排行榜失敗:', err);
        els.boardList.innerHTML = '<div class="item">載入失敗，請稍後再試</div>';
      }
    }

    els.board.onclick = () => openLeaderboard();
    els.closeBoard.onclick = () => els.boardModal.classList.remove('show');

    (async () => {
      try {
        const ctx = await ensureFirebase();
        bindAuthUI(ctx);
      } catch (err) {
        console.error('Auth init failed', err);
      }
    })();

    ensureStats(); updateHUD(); nextQuestion();
    addEventListener('keydown', (e) => {
      if (e.key >= '1' && e.key <= '4') {
        const idx = parseInt(e.key, 10) - 1;
        const btn = els.options.children[idx];
        if (btn && !lock) btn.click();
      }
      if (e.key === 'Enter') els.next.click();
    });
  </script>
  </div>
  <!-- 遊戲頁面結束 -->
</body>
</html>
