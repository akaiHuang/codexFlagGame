<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>ä¸–ç•Œåœ‹æ——æŒ‘æˆ°</title>
  <!-- Firebase é…ç½® - å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥ -->
  <script src="config/firebase.config.js"></script>
  <style>
    :root {
      --bg: #0f1220; --card: #161a2b; --text: #e7e9f7; --muted: #9aa1c3;
      --primary: #6ee7b7; --accent: #8ab4ff; --danger: #ff6b6b; --warn: #ffd166;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: linear-gradient(180deg,#0c0f1d,#121733 60%,#0f1220);
      color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height: 100svh; display: flex; flex-direction: column; align-items: center;
    }
    .wrap { width: min(720px, 100%); padding: env(safe-area-inset-top) 16px calc(12px + env(safe-area-inset-bottom)); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 4px; }
    h1 { margin:0; font-size:20px; letter-spacing:.5px }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    select, button, .pill {
      background: #1b2140; color: var(--text); border: 1px solid #2a315a; border-radius: 12px;
      padding: 10px 12px; font-size:14px;
    }
    button.primary { background: linear-gradient(135deg,#2a7f72,#26a69a); border: none; }
    button.ghost { background: #151a2f; }
    button:active { transform: scale(.98); }
    main { margin-top: 8px; }
    .card {
      background: radial-gradient(1200px 80% at 50% -10%,rgba(138,180,255,.06),transparent),
                  linear-gradient(0deg,rgba(110,231,183,.06),transparent 60%), var(--card);
      border: 1px solid #2a315a; border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position: relative; z-index: 1;
    }
    .flag-box {
      aspect-ratio: 4/3; border-radius: 12px; background: #0a0f24; border: 1px solid #2a315a;
      display:flex; align-items:center; justify-content:center; overflow:hidden; position: relative; z-index: 1;
    }
    .flag-box .flag { font-size: clamp(72px, 22vw, 140px); line-height:1; position: relative; z-index: 1; }
    .progress-badge {
      position: absolute; bottom: 12px; right: 12px; z-index: 10;
      background: rgba(10, 15, 36, 0.9); backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
    }
    .hint { color: var(--muted); font-size:13px; margin-top:6px; position: relative; z-index: 250; }
    .options { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:14px; }
    .opt {
      background: #131836; color: var(--text); border: 1px solid #2a315a; border-radius: 12px;
      padding: 12px; text-align:left; font-size:15px; line-height:1.25;
    }
    .opt.correct { border-color: #2dd4bf; background: #0f2a2a; }
    .opt.wrong { border-color: var(--danger); background: #2a1217; }
    .bar { display:flex; align-items:center; justify-content:space-between; margin-top:10px; color: var(--muted); font-size:13px }
    .stat { display:flex; gap:10px; align-items:center }
    .stat .pill { padding:6px 10px; border:1px solid #2a315a; background:#111735; border-radius:999px; }
    .shake { animation: shake .4s; }
    @keyframes shake { 10%, 90% { transform: translateX(-2px) } 20%, 80% { transform: translateX(3px) } 30%, 50%, 70% { transform: translateX(-6px) } 40%, 60% { transform: translateX(6px) } }
    .celebrate { animation: pulse .5s ease-out; }
    @keyframes pulse { 0%{ transform:scale(1)} 50%{ transform:scale(1.02)} 100%{ transform:scale(1)} }
    @media (prefers-reduced-motion: reduce) { .shake, .celebrate { animation: none !important; } }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 300; }
    .modal.show { display:flex; }
    .sheet { width:min(640px,100%); background:#0f132e; border:1px solid #2a315a; border-radius:16px; padding:16px; }
    .sheet h3 { margin:4px 0 10px }
    .table { font-size:14px; color:var(--muted); margin-top:8px; }
    .table .item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #243058; }
    canvas#fx { position: fixed; inset: 0; pointer-events: none; z-index: 200; }
    
    /* é¦–é æ¨£å¼ */
    #homePage {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #homePage.hidden { display: none; }
    
    /* åœ‹æ——èƒŒæ™¯å‹•ç•« */
    .flag-bg {
      position: absolute;
      inset: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      padding: 0;
      animation: scroll-left 80s linear infinite;
      width: 200%;
      overflow: hidden;
    }
    .flag-bg .flag-item {
      font-size: 160px;
      line-height: 0.7;
      flex-shrink: 0;
      opacity: 0.6;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    /* åŠé€æ˜é»‘è‰² + é«˜æ–¯æ¨¡ç³Šé®ç½© */
    .home-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    
    /* é¦–é å…§å®¹ */
    .home-content {
      position: relative;
      text-align: center;
      padding: 40px 20px;
      max-width: 500px;
    }
    .home-title {
      font-size: clamp(32px, 8vw, 56px);
      font-weight: 700;
      margin: 0 0 20px;
      background: linear-gradient(135deg, #6ee7b7, #8ab4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 1px;
    }
    .home-subtitle {
      font-size: 18px;
      color: var(--muted);
      margin-bottom: 40px;
    }
    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .home-btn {
      width: 280px;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .home-btn:active { transform: scale(0.98); }
    .home-btn.primary {
      background: linear-gradient(135deg, #2a7f72, #26a69a);
      color: white;
      box-shadow: 0 8px 24px rgba(42, 127, 114, 0.3);
    }
    .home-btn.primary:hover {
      box-shadow: 0 12px 32px rgba(42, 127, 114, 0.4);
    }
    .home-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    .home-btn-subtitle {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    /* èªè¨€åˆ‡æ›å™¨ */
    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      background: rgba(22, 26, 43, 0.8);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .lang-btn {
      font-size: 28px;
      cursor: pointer;
      opacity: 0.5;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 8px;
      background: transparent;
      border: none;
    }
    .lang-btn:hover {
      opacity: 0.8;
      transform: scale(1.1);
    }
    .lang-btn.active {
      opacity: 1;
      background: rgba(42, 127, 114, 0.3);
    }
    
    /* éŠæˆ²é é¢ */
    #gamePage.hidden { display: none; }
  </style>
</head>
<body>
  <!-- é¦–é  -->
  <div id="homePage">
    <!-- èªè¨€åˆ‡æ›å™¨ -->
    <div class="lang-switcher">
      <button class="lang-btn active" data-lang="zh-TW" title="ç¹é«”ä¸­æ–‡">ğŸ‡¹ğŸ‡¼</button>
      <button class="lang-btn" data-lang="zh-CN" title="ç®€ä½“ä¸­æ–‡">ğŸ‡¨ğŸ‡³</button>
      <button class="lang-btn" data-lang="en" title="English">ğŸ‡¬ğŸ‡§</button>
      <button class="lang-btn" data-lang="ja" title="æ—¥æœ¬èª">ğŸ‡¯ğŸ‡µ</button>
    </div>
    
    <!-- åœ‹æ——èƒŒæ™¯ -->
    <div class="flag-bg">
      <span class="flag-item">ğŸ‡¯ğŸ‡µ</span>
      <span class="flag-item">ğŸ‡°ğŸ‡·</span>
      <span class="flag-item">ğŸ‡¨ğŸ‡³</span>
      <span class="flag-item">ğŸ‡ºğŸ‡¸</span>
      <span class="flag-item">ğŸ‡¬ğŸ‡§</span>
      <span class="flag-item">ğŸ‡«ğŸ‡·</span>
      <span class="flag-item">ğŸ‡©ğŸ‡ª</span>
      <span class="flag-item">ğŸ‡®ğŸ‡¹</span>
      <span class="flag-item">ğŸ‡ªğŸ‡¸</span>
      <span class="flag-item">ğŸ‡·ğŸ‡º</span>
      <span class="flag-item">ğŸ‡§ğŸ‡·</span>
      <span class="flag-item">ğŸ‡²ğŸ‡½</span>
      <span class="flag-item">ğŸ‡¦ğŸ‡º</span>
      <span class="flag-item">ğŸ‡¨ğŸ‡¦</span>
      <span class="flag-item">ğŸ‡®ğŸ‡³</span>
      <span class="flag-item">ğŸ‡¹ğŸ‡­</span>
      <span class="flag-item">ğŸ‡»ğŸ‡³</span>
      <span class="flag-item">ğŸ‡µğŸ‡­</span>
      <span class="flag-item">ğŸ‡®ğŸ‡©</span>
      <span class="flag-item">ğŸ‡¸ğŸ‡¬</span>
      <!-- è¤‡è£½ä¸€çµ„å¯¦ç¾ç„¡ç¸«å¾ªç’° -->
      <span class="flag-item">ğŸ‡¯ğŸ‡µ</span>
      <span class="flag-item">ğŸ‡°ğŸ‡·</span>
      <span class="flag-item">ğŸ‡¨ğŸ‡³</span>
      <span class="flag-item">ğŸ‡ºğŸ‡¸</span>
      <span class="flag-item">ğŸ‡¬ğŸ‡§</span>
      <span class="flag-item">ğŸ‡«ğŸ‡·</span>
      <span class="flag-item">ğŸ‡©ğŸ‡ª</span>
      <span class="flag-item">ğŸ‡®ğŸ‡¹</span>
      <span class="flag-item">ğŸ‡ªğŸ‡¸</span>
      <span class="flag-item">ğŸ‡·ğŸ‡º</span>
      <span class="flag-item">ğŸ‡§ğŸ‡·</span>
      <span class="flag-item">ğŸ‡²ğŸ‡½</span>
      <span class="flag-item">ğŸ‡¦ğŸ‡º</span>
      <span class="flag-item">ğŸ‡¨ğŸ‡¦</span>
      <span class="flag-item">ğŸ‡®ğŸ‡³</span>
      <span class="flag-item">ğŸ‡¹ğŸ‡­</span>
      <span class="flag-item">ğŸ‡»ğŸ‡³</span>
      <span class="flag-item">ğŸ‡µğŸ‡­</span>
      <span class="flag-item">ğŸ‡®ğŸ‡©</span>
      <span class="flag-item">ğŸ‡¸ğŸ‡¬</span>
    </div>
    
    <!-- åŠé€æ˜é»‘è‰² + é«˜æ–¯æ¨¡ç³Šé®ç½© -->
    <div class="home-overlay"></div>
    
    <!-- é¦–é å…§å®¹ -->
    <div class="home-content">
      <h1 class="home-title">ä¸–ç•Œåœ‹æ——æŒ‘æˆ°</h1>
      <p class="home-subtitle">æ¸¬è©¦ä½ å°ä¸–ç•Œå„åœ‹åœ‹æ——çš„èªè­˜</p>
      <div class="home-buttons">
        <button id="startWithLogin" class="home-btn primary">
          é–‹å§‹éŠæˆ²
          <div class="home-btn-subtitle">Login by Google</div>
        </button>
      </div>
    </div>
  </div>

  <!-- éŠæˆ²é é¢ -->
  <div id="gamePage" class="hidden">
  <div class="wrap">
    <header>
      <h1 id="gameTitle" style="cursor: pointer;">ä¸–ç•Œåœ‹æ——æŒ‘æˆ°</h1>
      <div class="controls">
        <select id="region" aria-label="é¸æ“‡åœ°å€">
          <option value="global">å…¨çƒ</option>
          <option value="asia">äºæ´²</option>
          <option value="europe">æ­æ´²</option>
          <option value="africa">éæ´²</option>
          <option value="americas">ç¾æ´²</option>
          <option value="oceania">å¤§æ´‹æ´²</option>
        </select>
        <select id="difficulty" aria-label="é¸æ“‡é›£åº¦">
          <option value="easy">å®¹æ˜“</option>
          <option value="normal" selected>æ™®é€š</option>
          <option value="hard">å›°é›£</option>
        </select>
        <button id="mode" class="ghost" aria-label="åˆ‡æ›éŠæˆ²æ¨¡å¼">æ¨¡å¼ï¼šä¸€èˆ¬</button>
        <button id="reset" class="ghost" aria-label="é‡ç½®éŠæˆ²ç´€éŒ„">é‡ç½®ç´€éŒ„</button>
        <span id="userLabel" class="pill" aria-label="ç•¶å‰ä½¿ç”¨è€…">è¨ªå®¢</span>
      </div>
    </header>

    <main>
      <div id="card" class="card">
        <div class="flag-box" id="flagBox" role="img" aria-label="ç•¶å‰åœ‹æ——">
          <div id="flag" class="flag">ğŸ³ï¸â€ğŸŒˆ</div>
          <span class="progress-badge pill" aria-label="ç­”å°é€²åº¦"><span data-i18n="answered">å·²ç­”å°</span> <b id="correctCount">0</b>/<b id="totalFlags">0</b></span>
        </div>
        <div class="hint" id="hint" aria-live="polite">è«‹é¸å‡ºæ­£ç¢ºçš„åœ‹å®¶åç¨±</div>
        <div class="options" id="options" role="group" aria-label="ç­”æ¡ˆé¸é …"></div>
        <div class="bar">
          <div class="stat">
            <span class="pill" aria-label="ç•¶å‰æ­£ç¢ºç‡"><span data-i18n="accuracy">æ­£ç¢ºç‡</span> <b id="acc">0%</b></span>
            <span class="pill" aria-label="ç•¶å‰é€£å‹æ•¸"><span data-i18n="streak">é€£å‹</span> <b id="streak">0</b></span>
            <span class="pill" aria-label="ç´¯ç©ç¸½é¡Œæ•¸"><span data-i18n="total">ç¸½é¡Œæ•¸</span> <b id="total">0</b></span>
          </div>
          <div class="row">
            <button id="next" class="primary" aria-label="é€²å…¥ä¸‹ä¸€é¡Œ">ä¸‹ä¸€é¡Œ â–¶</button>
            <button id="stats" class="ghost" aria-label="æŸ¥çœ‹çµ±è¨ˆè³‡æ–™">çµ±è¨ˆ</button>
            <button id="board" class="ghost" aria-label="æŸ¥çœ‹æ’è¡Œæ¦œ">æ’è¡Œæ¦œ</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <canvas id="fx"></canvas>

  <div id="statsModal" class="modal" role="dialog" aria-labelledby="statsTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="statsTitle" data-i18n="myStats">æˆ‘çš„çµ±è¨ˆ</h3>
        <button id="closeStats" class="ghost" aria-label="é—œé–‰çµ±è¨ˆè¦–çª—" data-i18n="close">é—œé–‰</button>
      </div>
      <div class="row" style="gap:12px">
        <div class="pill"><span data-i18n="accuracyRate">æº–ç¢ºç‡</span> <b id="s_acc">0%</b></div>
        <div class="pill"><span data-i18n="bestStreak">æœ€ä½³é€£å‹</span> <b id="s_best">0</b></div>
        <div class="pill"><span data-i18n="totalQuestions">ç´¯è¨ˆé¡Œæ•¸</span> <b id="s_total">0</b></div>
      </div>
      <div class="table" id="wrongList"></div>
    </div>
  </div>

  <div id="boardModal" class="modal" role="dialog" aria-labelledby="boardTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="boardTitle" data-i18n="leaderboardTitle">æ’è¡Œæ¦œ</h3>
        <button id="closeBoard" class="ghost" aria-label="é—œé–‰æ’è¡Œæ¦œè¦–çª—" data-i18n="close">é—œé–‰</button>
      </div>
      <div class="table" id="boardList"></div>
    </div>
  </div>

  <div id="authModal" class="modal" role="dialog" aria-labelledby="authTitle" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="authTitle" data-i18n="login">ç™»å…¥</h3>
        <button id="closeAuth" class="ghost" aria-label="é—œé–‰ç™»å…¥è¦–çª—" data-i18n="close">é—œé–‰</button>
      </div>
      <div class="row" style="flex-direction:column; align-items:stretch; gap:10px; margin-top:20px">
        <button id="googleLogin" class="primary" aria-label="ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥" data-i18n="googleLogin">ä½¿ç”¨ Google ç™»å…¥</button>
        <button id="guestContinue" class="ghost" aria-label="ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ" data-i18n="guestContinue">ä»¥è¨ªå®¢ç¹¼çºŒ</button>
      </div>
      <div class="row" style="margin-top:12px">
        <input id="nickname" placeholder="æš±ç¨±ï¼ˆé¸å¡«ï¼Œåƒ…ä¾›æ’è¡Œæ¦œé¡¯ç¤ºï¼‰" maxlength="24" aria-label="è¼¸å…¥æš±ç¨±"
               style="padding:10px;border-radius:8px;border:1px solid #2a315a;background:#0f132e;color:#e7e9f7;width:100%" />
      </div>
    </div>
  </div>

  <script>
    // é é¢åˆ‡æ›é‚è¼¯
    const homePage = document.getElementById('homePage');
    const gamePage = document.getElementById('gamePage');
    const startWithLogin = document.getElementById('startWithLogin');
    
    function showGame() {
      homePage.classList.add('hidden');
      gamePage.classList.remove('hidden');
    }
    
    function showHome() {
      gamePage.classList.add('hidden');
      homePage.classList.remove('hidden');
    }
    
    // ç¨å¾ŒæœƒåŠ å…¥ gameTitle çš„é»æ“Šäº‹ä»¶
    
    // èªè¨€ä»£ç¢¼æ˜ å°„åˆ° Intl.DisplayNames æ”¯æ´çš„ locale
    const langToLocale = {
      'zh-TW': 'zh-Hant',
      'zh-CN': 'zh-Hans',
      'en': 'en',
      'ja': 'ja'
    };

    // å‹•æ…‹ç²å–åœ‹å®¶åç¨±ï¼ˆæ ¹æ“šç•¶å‰èªè¨€ï¼‰
    function getCountryName(code) {
      try {
        const locale = langToLocale[currentLang] || 'zh-Hant';
        const intl = new Intl.DisplayNames([locale], { type: 'region' });
        return intl.of(code) || code;
      } catch {
        return code;
      }
    }

    const R = { AS:'asia', EU:'europe', AF:'africa', AM:'americas', OC:'oceania' };
    const RAW = {
      asia: 'JP CN TW HK MO KR KP VN TH MY SG ID PH IN PK BD LK NP KH LA MM MN AE SA QA KW OM BH JO IL TR IR IQ SY LB',
      europe: 'FR DE IT ES PT NL BE LU IE GB NO SE FI DK IS PL CZ SK HU AT CH LI SI HR BA RS ME MK AL GR BG RO MD UA BY LT LV EE',
      africa: 'EG MA DZ TN LY ET KE UG TZ RW BI GH NG CI SN CM CD ZA NA BW ZM ZW AO MZ MG',
      americas: 'US CA MX CU DO HT JM PA CR NI SV GT HN CO VE PE EC BO PY UY AR CL BR',
      oceania: 'AU NZ PG FJ WS TO'
    };
    const COUNTRIES = Object.entries(RAW)
      .flatMap(([region, s]) => s.split(' ').map(code => ({ code, region })));

    function codeToFlagEmoji(code) {
      return code.toUpperCase().replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt()));
    }
    const rand = (n) => Math.floor(Math.random() * n);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=rand(i+1); [a[i],a[j]]=[a[j],a[i]] } return a; }

    const store = {
      get(){ try { return JSON.parse(localStorage.getItem('fg_stats')||'{}') } catch { return {} } },
      set(d){ localStorage.setItem('fg_stats', JSON.stringify(d)) },
      reset(){ localStorage.removeItem('fg_stats') }
    };
    function ensureStats() {
      const s = store.get();
      s.total ??= 0; s.correct ??= 0; s.streak ??= 0; s.bestStreak ??= 0; s.by ??= {}; s.correctFlags ??= [];
      store.set(s); return s;
    }

    async function saveProfileName(ctx, uid, name) {
      if (!name) return;
      try {
        const now = ctx.serverTimestamp();
        await ctx.setDoc(ctx.doc(ctx.db, 'profiles', uid), {
          uid,
          name,
          createdAt: now,
          updatedAt: now
        }, { merge: true });
      } catch (error) {
        console.error('å„²å­˜ä½¿ç”¨è€…åç¨±å¤±æ•—:', error);
        showNotification('ç„¡æ³•å„²å­˜ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    async function augmentWithNames(ctx, rows) {
      const uids = [...new Set(rows.map(r => r.uid).filter(Boolean))];
      if (!uids.length) return rows;
      try {
        const entries = await Promise.all(uids.map(async (uid) => {
          try {
            const snap = await ctx.getDoc(ctx.doc(ctx.db, 'profiles', uid));
            return [uid, snap.exists() ? (snap.data().name || '') : ''];
          } catch (error) {
            console.error(`å–å¾—ä½¿ç”¨è€… ${uid} è³‡æ–™å¤±æ•—:`, error);
            return [uid, ''];
          }
        }));
        const nameMap = Object.fromEntries(entries);
        return rows.map(r => ({ ...r, name: nameMap[r.uid] || '' }));
      } catch (error) {
        console.error('è™•ç†ä½¿ç”¨è€…åç¨±å¤±æ•—:', error);
        return rows;
      }
    }

    function showAuth(show = true) {
      els.authModal.classList[show ? 'add' : 'remove']('show');
      if (show) {
        els.authModal.setAttribute('aria-hidden', 'false');
        els.nicknameInput.focus();
      } else {
        els.authModal.setAttribute('aria-hidden', 'true');
      }
    }

    function showNotification(message, type = 'info') {
      // ç°¡å–®çš„é€šçŸ¥ç³»çµ±ï¼Œå¯ä»¥é€²ä¸€æ­¥æ“´å……
      els.hint.textContent = message;
      if (type === 'error') {
        console.error(message);
      }
    }

    function labelForUser(user) {
      if (!user) return 'è¨ªå®¢';
      if (user.isAnonymous) return 'è¨ªå®¢';
      if (user.displayName) return user.displayName;
      if (user.email) return user.email.split('@')[0];
      return user.uid.slice(-6);
    }

    function bindAuthUI(ctx) {
      const {
        auth,
        signInAnonymously,
        signOut,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged
      } = ctx;

      let initial = true;
      onAuthStateChanged(auth, async (user) => {
        if (initial && !user) {
          initial = false;
          return; // ä¸è‡ªå‹•åŒ¿åç™»å…¥ï¼Œç­‰å¾…ä½¿ç”¨è€…é¸æ“‡
        }
        initial = false;
        els.userLabel.textContent = labelForUser(user);
        const loggedIn = !!user && !user.isAnonymous;
        if (loggedIn) {
          const nickname = els.nicknameInput.value.trim();
          if (nickname) await saveProfileName(ctx, user.uid, nickname);
        }
        showAuth(false);
      });

      // é¦–é æŒ‰éˆ•
      startWithLogin.onclick = () => {
        showGame();
        showAuth(true); // é¡¯ç¤ºç™»å…¥è¦–çª—
      };
      
      // èªè¨€åˆ‡æ›æŒ‰éˆ•
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.onclick = () => switchLanguage(btn.dataset.lang);
      });
      
      // åˆå§‹åŒ–èªè¨€
      switchLanguage(currentLang);
      
      // éŠæˆ²æ¨™é¡Œé»æ“Šè¿”å›é¦–é 
      els.gameTitle.onclick = () => showHome();

      els.closeAuth.onclick = () => showAuth(false);
      els.guestContinue.onclick = async () => {
        if (!auth.currentUser || !auth.currentUser.isAnonymous) {
          await signInAnonymously(auth).catch(err => showNotification(`åŒ¿åç™»å…¥å¤±æ•—ï¼š${err.message}`, 'error'));
        }
        showAuth(false);
      };
      els.googleLogin.onclick = async () => {
        const provider = new GoogleAuthProvider();
        try {
          const cred = await signInWithPopup(auth, provider);
          const nickname = (els.nicknameInput.value.trim() || cred.user.displayName || '').slice(0, 24);
          if (nickname) await saveProfileName(ctx, cred.user.uid, nickname);
        } catch (err) {
          console.error('Google ç™»å…¥å¤±æ•—:', err);
          showNotification(`ç™»å…¥å¤±æ•—ï¼š${err.message}`, 'error');
        }
      };
    }

    function weightFor(code, mode) {
      const s = store.get(); const c = (s.by?.[code]) || {};
      const seen = c.seen || 0, wrong = c.wrong || 0, streak = c.streak || 0, score = c.score ?? 0;
      let w = 1 + wrong*2 + Math.max(0, 3 - streak) - Math.min(score, 2)*0.5;
      if (seen < 2) w += 0.4;
      if (mode === 'train') w *= 1.6;
      return Math.max(0.2, w);
    }
    function weightedPick(items, wfn) {
      const weights = items.map(wfn);
      const sum = weights.reduce((a,b)=>a+b,0) || items.length;
      let r = Math.random() * sum;
      for (let i=0;i<items.length;i++){ if ((r -= weights[i]) <= 0) return items[i]; }
      return items[items.length-1];
    }
    function getPool(region) {
      return region==='global' ? COUNTRIES.slice() : COUNTRIES.filter(c => c.region === region);
    }
    function fillTo(a, need, supply, excludeSet) {
      for (const x of supply) { if (a.length >= need) break; if (!excludeSet.has(x.code)) a.push(x); }
      return a;
    }
    function getDecoys(pool, correct, difficulty) {
      const exclude = new Set([correct.code]);
      let primary, fallback;
      if (difficulty === 'easy') {
        primary = pool.filter(c => c.region !== correct.region && c.code !== correct.code);
        fallback = pool.filter(c => c.code !== correct.code);
      } else if (difficulty === 'hard') {
        primary = pool.filter(c => c.region === correct.region && c.code !== correct.code);
        fallback = pool.filter(c => c.code !== correct.code);
      } else {
        primary = pool.filter(c => c.code !== correct.code);
        fallback = primary;
      }
      let picks = shuffle(primary).slice(0, 3);
      if (picks.length < 3) picks = fillTo(picks, 3, shuffle(fallback), exclude);
      return picks;
    }

    let current = null;
    let lock = false;
    let mode = 'normal';

    const els = {
      gameTitle: document.getElementById('gameTitle'),
      region: document.getElementById('region'),
      difficulty: document.getElementById('difficulty'),
      mode: document.getElementById('mode'),
      reset: document.getElementById('reset'),
      flag: document.getElementById('flag'),
      flagBox: document.getElementById('flagBox'),
      options: document.getElementById('options'),
      hint: document.getElementById('hint'),
      next: document.getElementById('next'),
      acc: document.getElementById('acc'),
      streak: document.getElementById('streak'),
      total: document.getElementById('total'),
      correctCount: document.getElementById('correctCount'),
      totalFlags: document.getElementById('totalFlags'),
      stats: document.getElementById('stats'),
      board: document.getElementById('board'),
      statsModal: document.getElementById('statsModal'),
      closeStats: document.getElementById('closeStats'),
      s_acc: document.getElementById('s_acc'),
      s_best: document.getElementById('s_best'),
      s_total: document.getElementById('s_total'),
      wrongList: document.getElementById('wrongList'),
      card: document.getElementById('card'),
      fx: document.getElementById('fx'),
      boardModal: document.getElementById('boardModal'),
      closeBoard: document.getElementById('closeBoard'),
      boardList: document.getElementById('boardList'),
      userLabel: document.getElementById('userLabel'),
      authModal: document.getElementById('authModal'),
      closeAuth: document.getElementById('closeAuth'),
      googleLogin: document.getElementById('googleLogin'),
      guestContinue: document.getElementById('guestContinue'),
      nicknameInput: document.getElementById('nickname')
    };

    const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
    const ctx = els.fx.getContext('2d');
    let particles = [];
    function resizeCanvas(){ els.fx.width = innerWidth; els.fx.height = innerHeight; }
    addEventListener('resize', resizeCanvas, {passive:true}); resizeCanvas();
    function spawnConfetti(amount=60) {
      if (prefersReduced) return;
      const colors = ['#6ee7b7','#8ab4ff','#ffd166','#ff6b6b','#c084fc','#f472b6'];
      const rect = els.flagBox.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const top = rect.top;
      for (let i=0;i<amount;i++){
        particles.push({
          x: cx + (Math.random() - .5) * rect.width * 0.6,
          y: top - 10 + Math.random()*10,
          vx: (Math.random() - .5) * 4,
          vy: 2 + Math.random() * 3,
          g: .08 + Math.random() * .08,
          a: 1, r: 2 + Math.random() * 3,
          c: colors[rand(colors.length)], ttl: 90 + rand(40)
        });
      }
    }
    function tick() {
      ctx.clearRect(0,0,els.fx.width,els.fx.height);
      
      // å¦‚æœæ²’æœ‰ç²’å­ï¼Œåœæ­¢å‹•ç•«å¾ªç’°ä»¥ç¯€çœæ•ˆèƒ½
      if (particles.length === 0) {
        requestAnimationFrame(tick);
        return;
      }
      
      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.ttl--;
        p.a = Math.max(0, p.ttl/120);
        ctx.globalAlpha = p.a; ctx.fillStyle = p.c;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        if (p.ttl <= 0 || p.y > innerHeight+20) particles.splice(i,1);
      }
      requestAnimationFrame(tick);
    }
    tick();

    function vibrate(pattern){ if (navigator.vibrate) try { navigator.vibrate(pattern) } catch {} }

    function updateHUD() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      els.acc.textContent = acc + '%';
      els.streak.textContent = s.streak || 0;
      els.total.textContent = s.total || 0;
      
      // è¨ˆç®—ç•¶å‰åœ°å€çš„åœ‹æ——ç¸½æ•¸
      const regionVal = els.region.value;
      let totalFlagsInRegion = 0;
      if (regionVal === 'global') {
        totalFlagsInRegion = COUNTRIES.length;
      } else {
        totalFlagsInRegion = COUNTRIES.filter(c => c.region === regionVal).length;
      }
      
      // è¨ˆç®—ç•¶å‰åœ°å€å·²ç­”å°çš„åœ‹æ——æ•¸
      const correctFlags = s.correctFlags || [];
      const correctInRegion = regionVal === 'global' 
        ? correctFlags.length
        : correctFlags.filter(code => {
            const country = COUNTRIES.find(c => c.code === code);
            return country && country.region === regionVal;
          }).length;
      
      els.correctCount.textContent = correctInRegion;
      els.totalFlags.textContent = totalFlagsInRegion;
    }

    function updateStatsModal() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      els.s_acc.textContent = acc + '%';
      els.s_best.textContent = s.bestStreak || 0;
      els.s_total.textContent = s.total || 0;
      const items = Object.entries(s.by || {})
        .map(([code, v]) => ({ code, wrong: v.wrong||0, seen: v.seen||0 }))
        .filter(x => x.wrong > 0)
        .sort((a,b)=> (b.wrong/(b.seen||1)) - (a.wrong/(a.seen||1)))
        .slice(0, 12);
      els.wrongList.innerHTML = items.length ? items.map(it => {
        const name = getCountryName(it.code);
        const rate = it.seen ? Math.round((1 - it.wrong/it.seen)*100) : 0;
        return `<div class="item"><span>${codeToFlagEmoji(it.code)} ${name}</span><span>éŒ¯ ${it.wrong}ï½œæ­£ç¢ºç‡ ${rate}%</span></div>`;
      }).join('') : '<div class="item">ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„</div>';
    }

    function pickQuestion() {
      const region = els.region.value;
      const pool = getPool(region);
      let candidates = pool;
      if (mode === 'train') {
        const s = store.get();
        const wrongOnes = pool.filter(c => (s.by?.[c.code]?.wrong || 0) > 0);
        if (wrongOnes.length) candidates = wrongOnes;
      }
      const correct = weightedPick(candidates, c => weightFor(c.code, mode));
      const decoys = getDecoys(pool, correct, els.difficulty.value);
      const options = shuffle([correct, ...decoys]).map(x => x.code);
      return { correct: correct.code, options, region };
    }

    function renderQuestion() {
      current = pickQuestion();
      els.flag.textContent = codeToFlagEmoji(current.correct);
      els.hint.textContent = t('hint');
      els.options.innerHTML = '';
      els.card.classList.remove('shake','celebrate');
      
      // æ›´æ–° aria-label è®“è¢å¹•é–±è®€å™¨çŸ¥é“æ——å¹Ÿå·²æ›´æ–°
      els.flagBox.setAttribute('aria-label', `åœ‹æ——ï¼š${getCountryName(current.correct)}`);
      
      const frag = document.createDocumentFragment();
      current.options.forEach((optCode, index) => {
        const btn = document.createElement('button');
        btn.className = 'opt';
        btn.dataset.code = optCode;
        btn.textContent = getCountryName(optCode);
        btn.setAttribute('aria-label', `é¸é … ${index + 1}ï¼š${getCountryName(optCode)}`);
        btn.onclick = () => answer(optCode);
        frag.appendChild(btn);
      });
      els.options.appendChild(frag);
    }

    function answer(chosen) {
      if (lock) return;
      lock = true;
      const s = ensureStats();
      s.total = (s.total || 0) + 1;
      const correct = chosen === current.correct;
      [...els.options.children].forEach(b => {
        const code = b.dataset.code;
        if (code === current.correct) b.classList.add('correct');
        if (code === chosen && !correct) b.classList.add('wrong');
        b.disabled = true;
      });
      const cc = current.correct;
      s.by[cc] ??= { seen:0, wrong:0, streak:0, score:0 };
      const cs = s.by[cc];
      cs.seen += 1;
      if (correct) {
        s.correct = (s.correct || 0) + 1;
        s.streak = (s.streak || 0) + 1;
        s.bestStreak = Math.max(s.bestStreak || 0, s.streak);
        cs.streak = (cs.streak || 0) + 1;
        cs.score = (cs.score ?? 0) + 1;
        // è¨˜éŒ„ç­”å°çš„åœ‹æ——
        s.correctFlags = s.correctFlags || [];
        if (!s.correctFlags.includes(cc)) {
          s.correctFlags.push(cc);
        }
        els.card.classList.add('celebrate');
        spawnConfetti(70 + Math.min(60, (s.streak||0) * 5));
        vibrate(30);
        els.hint.textContent = t('correct');
      } else {
        s.streak = 0;
        cs.wrong = (cs.wrong || 0) + 1;
        cs.streak = 0;
        cs.score = Math.max(0, (cs.score ?? 0) - 1);
        els.card.classList.add('shake');
        vibrate([20, 80, 20]);
        els.hint.textContent = t('wrong') + getCountryName(cc);
      }
      store.set(s);
      updateHUD();
    }

    function nextQuestion() { lock = false; renderQuestion(); }

    els.next.onclick = () => nextQuestion();
    els.region.onchange = () => { nextQuestion(); updateHUD(); };
    els.difficulty.onchange = () => nextQuestion();
    els.reset.onclick = () => {
      if (confirm('ç¢ºå®šè¦é‡ç½®æœ¬æ©Ÿç´€éŒ„å—ï¼Ÿ')) { store.reset(); ensureStats(); updateHUD(); nextQuestion(); }
    };
    els.stats.onclick = () => { updateStatsModal(); els.statsModal.classList.add('show'); };
    els.closeStats.onclick = () => els.statsModal.classList.remove('show');
    els.mode.onclick = () => {
      mode = (mode === 'normal') ? 'train' : 'normal';
      els.mode.textContent = 'æ¨¡å¼ï¼š' + (mode === 'normal' ? 'ä¸€èˆ¬' : 'è¨“ç·´');
      nextQuestion();
    };

    const REGION_LABEL = {
      global: 'å…¨çƒ',
      asia: 'äºæ´²',
      europe: 'æ­æ´²',
      africa: 'éæ´²',
      americas: 'ç¾æ´²',
      oceania: 'å¤§æ´‹æ´²'
    };

    // å¤šèªç³»å­—å…¸
    const i18n = {
      'zh-TW': {
        homeTitle: 'ä¸–ç•Œåœ‹æ——æŒ‘æˆ°',
        homeSubtitle: 'æ¸¬è©¦ä½ å°ä¸–ç•Œå„åœ‹åœ‹æ——çš„èªè­˜',
        startGame: 'é–‹å§‹éŠæˆ²',
        loginByGoogle: 'Login by Google',
        gameTitle: 'ä¸–ç•Œåœ‹æ——æŒ‘æˆ°',
        selectRegion: 'é¸æ“‡åœ°å€',
        selectDifficulty: 'é¸æ“‡é›£åº¦',
        mode: 'æ¨¡å¼ï¼š',
        modeNormal: 'ä¸€èˆ¬',
        modeTime: 'è¨ˆæ™‚',
        resetRecord: 'é‡ç½®ç´€éŒ„',
        guest: 'è¨ªå®¢',
        hint: 'è«‹é¸å‡ºæ­£ç¢ºçš„åœ‹å®¶åç¨±',
        nextQuestion: 'ä¸‹ä¸€é¡Œ â–¶',
        statistics: 'çµ±è¨ˆ',
        leaderboard: 'æ’è¡Œæ¦œ',
        accuracy: 'æ­£ç¢ºç‡',
        streak: 'é€£å‹',
        total: 'ç¸½é¡Œæ•¸',
        answered: 'å·²ç­”å°',
        easy: 'å®¹æ˜“',
        normal: 'æ™®é€š',
        hard: 'å›°é›£',
        global: 'å…¨çƒ',
        asia: 'äºæ´²',
        europe: 'æ­æ´²',
        africa: 'éæ´²',
        americas: 'ç¾æ´²',
        oceania: 'å¤§æ´‹æ´²',
        // å½ˆçª—ç›¸é—œ
        close: 'é—œé–‰',
        login: 'ç™»å…¥',
        googleLogin: 'ä½¿ç”¨ Google ç™»å…¥',
        guestContinue: 'ä»¥è¨ªå®¢ç¹¼çºŒ',
        nicknamePlaceholder: 'æš±ç¨±ï¼ˆé¸å¡«ï¼Œåƒ…ä¾›æ’è¡Œæ¦œé¡¯ç¤ºï¼‰',
        myStats: 'æˆ‘çš„çµ±è¨ˆ',
        accuracyRate: 'æº–ç¢ºç‡',
        bestStreak: 'æœ€ä½³é€£å‹',
        totalQuestions: 'ç´¯è¨ˆé¡Œæ•¸',
        wrongAnswers: 'ç­”éŒ¯è¨˜éŒ„',
        leaderboardTitle: 'æ’è¡Œæ¦œ',
        // éŠæˆ²è¨Šæ¯
        correct: 'æ­£ç¢ºï¼',
        wrong: 'ç­”éŒ¯å•¦ï¼Œæ­£è§£ï¼š'
      },
      'zh-CN': {
        homeTitle: 'ä¸–ç•Œå›½æ——æŒ‘æˆ˜',
        homeSubtitle: 'æµ‹è¯•ä½ å¯¹ä¸–ç•Œå„å›½å›½æ——çš„è®¤è¯†',
        startGame: 'å¼€å§‹æ¸¸æˆ',
        loginByGoogle: 'Login by Google',
        gameTitle: 'ä¸–ç•Œå›½æ——æŒ‘æˆ˜',
        selectRegion: 'é€‰æ‹©åœ°åŒº',
        selectDifficulty: 'é€‰æ‹©éš¾åº¦',
        mode: 'æ¨¡å¼ï¼š',
        modeNormal: 'ä¸€èˆ¬',
        modeTime: 'è®¡æ—¶',
        resetRecord: 'é‡ç½®è®°å½•',
        guest: 'è®¿å®¢',
        hint: 'è¯·é€‰å‡ºæ­£ç¡®çš„å›½å®¶åç§°',
        nextQuestion: 'ä¸‹ä¸€é¢˜ â–¶',
        statistics: 'ç»Ÿè®¡',
        leaderboard: 'æ’è¡Œæ¦œ',
        accuracy: 'æ­£ç¡®ç‡',
        streak: 'è¿èƒœ',
        total: 'æ€»é¢˜æ•°',
        answered: 'å·²ç­”å¯¹',
        easy: 'å®¹æ˜“',
        normal: 'æ™®é€š',
        hard: 'å›°éš¾',
        global: 'å…¨çƒ',
        asia: 'äºšæ´²',
        europe: 'æ¬§æ´²',
        africa: 'éæ´²',
        americas: 'ç¾æ´²',
        oceania: 'å¤§æ´‹æ´²',
        // å½ˆçª—ç›¸é—œ
        close: 'å…³é—­',
        login: 'ç™»å…¥',
        googleLogin: 'ä½¿ç”¨ Google ç™»å…¥',
        guestContinue: 'ä»¥è®¿å®¢ç»§ç»­',
        nicknamePlaceholder: 'æ˜µç§°ï¼ˆé€‰å¡«ï¼Œä»…ä¾›æ’è¡Œæ¦œæ˜¾ç¤ºï¼‰',
        myStats: 'æˆ‘çš„ç»Ÿè®¡',
        accuracyRate: 'å‡†ç¡®ç‡',
        bestStreak: 'æœ€ä½³è¿èƒœ',
        totalQuestions: 'ç´¯è®¡é¢˜æ•°',
        wrongAnswers: 'ç­”é”™è®°å½•',
        leaderboardTitle: 'æ’è¡Œæ¦œ',
        // éŠæˆ²è¨Šæ¯
        correct: 'æ­£ç¡®ï¼',
        wrong: 'ç­”é”™äº†ï¼Œæ­£è§£ï¼š'
      },
      'en': {
        homeTitle: 'World Flag Challenge',
        homeSubtitle: 'Test your knowledge of world flags',
        startGame: 'Start Game',
        loginByGoogle: 'Login by Google',
        gameTitle: 'World Flag Challenge',
        selectRegion: 'Select Region',
        selectDifficulty: 'Select Difficulty',
        mode: 'Mode: ',
        modeNormal: 'Normal',
        modeTime: 'Timed',
        resetRecord: 'Reset Record',
        guest: 'Guest',
        hint: 'Select the correct country name',
        nextQuestion: 'Next â–¶',
        statistics: 'Statistics',
        leaderboard: 'Leaderboard',
        accuracy: 'Accuracy',
        streak: 'Streak',
        total: 'Total',
        answered: 'Answered',
        easy: 'Easy',
        normal: 'Normal',
        hard: 'Hard',
        global: 'Global',
        asia: 'Asia',
        europe: 'Europe',
        africa: 'Africa',
        americas: 'Americas',
        oceania: 'Oceania',
        // Modal related
        close: 'Close',
        login: 'Login',
        googleLogin: 'Sign in with Google',
        guestContinue: 'Continue as Guest',
        nicknamePlaceholder: 'Nickname (optional, for leaderboard)',
        myStats: 'My Statistics',
        accuracyRate: 'Accuracy',
        bestStreak: 'Best Streak',
        totalQuestions: 'Total Questions',
        wrongAnswers: 'Wrong Answers',
        leaderboardTitle: 'Leaderboard',
        // Game messages
        correct: 'Correct!',
        wrong: 'Wrong! Answer: '
      },
      'ja': {
        homeTitle: 'ä¸–ç•Œã®å›½æ——ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
        homeSubtitle: 'ä¸–ç•Œå„å›½ã®å›½æ——ã®çŸ¥è­˜ã‚’ãƒ†ã‚¹ãƒˆ',
        startGame: 'ã‚²ãƒ¼ãƒ é–‹å§‹',
        loginByGoogle: 'Login by Google',
        gameTitle: 'ä¸–ç•Œã®å›½æ——ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
        selectRegion: 'åœ°åŸŸã‚’é¸æŠ',
        selectDifficulty: 'é›£æ˜“åº¦ã‚’é¸æŠ',
        mode: 'ãƒ¢ãƒ¼ãƒ‰ï¼š',
        modeNormal: 'é€šå¸¸',
        modeTime: 'ã‚¿ã‚¤ãƒ ',
        resetRecord: 'è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ',
        guest: 'ã‚²ã‚¹ãƒˆ',
        hint: 'æ­£ã—ã„å›½åã‚’é¸æŠã—ã¦ãã ã•ã„',
        nextQuestion: 'æ¬¡ã¸ â–¶',
        statistics: 'çµ±è¨ˆ',
        leaderboard: 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°',
        accuracy: 'æ­£è§£ç‡',
        streak: 'é€£å‹',
        total: 'ç·å•é¡Œæ•°',
        answered: 'æ­£è§£æ•°',
        easy: 'ç°¡å˜',
        normal: 'æ™®é€š',
        hard: 'é›£ã—ã„',
        global: 'ã‚°ãƒ­ãƒ¼ãƒãƒ«',
        asia: 'ã‚¢ã‚¸ã‚¢',
        europe: 'ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘',
        africa: 'ã‚¢ãƒ•ãƒªã‚«',
        americas: 'ã‚¢ãƒ¡ãƒªã‚«å¤§é™¸',
        oceania: 'ã‚ªã‚»ã‚¢ãƒ‹ã‚¢',
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        close: 'é–‰ã˜ã‚‹',
        login: 'ãƒ­ã‚°ã‚¤ãƒ³',
        googleLogin: 'Googleã§ãƒ­ã‚°ã‚¤ãƒ³',
        guestContinue: 'ã‚²ã‚¹ãƒˆã¨ã—ã¦ç¶šã‘ã‚‹',
        nicknamePlaceholder: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰',
        myStats: 'ãƒã‚¤çµ±è¨ˆ',
        accuracyRate: 'æ­£è§£ç‡',
        bestStreak: 'æœ€é«˜é€£å‹',
        totalQuestions: 'ç·å•é¡Œæ•°',
        wrongAnswers: 'é–“é•ãˆãŸå•é¡Œ',
        leaderboardTitle: 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°',
        // ã‚²ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        correct: 'æ­£è§£ï¼',
        wrong: 'ä¸æ­£è§£ï¼æ­£è§£ï¼š'
      }
    };

    // ç•¶å‰èªè¨€
    let currentLang = localStorage.getItem('language') || 'zh-TW';

    // åˆ‡æ›èªè¨€å‡½æ•¸
    function switchLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('language', lang);
      updateUI();
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // å¦‚æœç•¶å‰æœ‰é¡Œç›®é¡¯ç¤ºï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°åœ‹å®¶åç¨±
      if (current && !gamePage.classList.contains('hidden')) {
        // é‡æ–°æ¸²æŸ“é¸é …æŒ‰éˆ•çš„æ–‡å­—
        const optionButtons = els.options.querySelectorAll('.opt');
        optionButtons.forEach(btn => {
          const code = btn.dataset.code;
          btn.textContent = getCountryName(code);
          const index = Array.from(optionButtons).indexOf(btn);
          btn.setAttribute('aria-label', `é¸é … ${index + 1}ï¼š${getCountryName(code)}`);
        });
        
        // æ›´æ–°åœ‹æ——çš„ aria-label
        els.flagBox.setAttribute('aria-label', `åœ‹æ——ï¼š${getCountryName(current.correct)}`);
      }
    }

    // ç²å–ç¿»è­¯æ–‡å­—
    function t(key) {
      return i18n[currentLang]?.[key] || i18n['zh-TW'][key] || key;
    }

    // æ›´æ–° UI æ–‡å­—
    function updateUI() {
      // é¦–é 
      const homeTitle = document.querySelector('.home-title');
      const homeSubtitle = document.querySelector('.home-subtitle');
      const startBtn = document.querySelector('#startWithLogin');
      const loginSubtitle = startBtn?.querySelector('.home-btn-subtitle');
      
      if (homeTitle) homeTitle.textContent = t('homeTitle');
      if (homeSubtitle) homeSubtitle.textContent = t('homeSubtitle');
      if (startBtn) {
        startBtn.childNodes[0].textContent = t('startGame') + ' ';
      }
      if (loginSubtitle) loginSubtitle.textContent = t('loginByGoogle');
      
      // éŠæˆ²é é¢
      const gameTitle = document.querySelector('#gameTitle');
      const hint = document.querySelector('#hint');
      const nextBtn = document.querySelector('#next');
      const statsBtn = document.querySelector('#stats');
      const boardBtn = document.querySelector('#board');
      const modeBtn = document.querySelector('#mode');
      const resetBtn = document.querySelector('#reset');
      
      if (gameTitle) gameTitle.textContent = t('gameTitle');
      if (hint) hint.textContent = t('hint');
      if (nextBtn) nextBtn.textContent = t('nextQuestion');
      if (statsBtn) statsBtn.textContent = t('statistics');
      if (boardBtn) boardBtn.textContent = t('leaderboard');
      if (resetBtn) resetBtn.textContent = t('resetRecord');
      
      // æ›´æ–°æ¨¡å¼æŒ‰éˆ•
      if (modeBtn) {
        const isTimeMode = store.mode === 'time';
        modeBtn.textContent = t('mode') + (isTimeMode ? t('modeTime') : t('modeNormal'));
      }
      
      // æ›´æ–°åœ°å€å’Œé›£åº¦é¸é …
      const regionSelect = document.querySelector('#region');
      if (regionSelect) {
        Array.from(regionSelect.options).forEach(opt => {
          const key = opt.value;
          opt.textContent = t(key);
        });
      }
      
      const difficultySelect = document.querySelector('#difficulty');
      if (difficultySelect) {
        Array.from(difficultySelect.options).forEach(opt => {
          const key = opt.value;
          opt.textContent = t(key);
        });
      }
      
      // æ›´æ–°æ‰€æœ‰å¸¶æœ‰ data-i18n å±¬æ€§çš„å…ƒç´ 
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // æ›´æ–° placeholder
      const nicknameInput = document.querySelector('#nickname');
      if (nicknameInput) {
        nicknameInput.placeholder = t('nicknamePlaceholder');
      }
    }

    const firebaseConfig = window.__FLAG_APP_FIREBASE__ || {
      apiKey: '',
      authDomain: '',
      projectId: '',
      storageBucket: '',
      messagingSenderId: '',
      appId: '',
      measurementId: ''
    };
    let fbInit;
    function readyConfig(cfg){ return cfg.apiKey && cfg.projectId && cfg.appId && cfg.authDomain; }

    async function ensureFirebase() {
      if (!readyConfig(firebaseConfig)) {
        alert('å°šæœªè¨­å®š Firebase Configï¼Œè«‹å…ˆå¡«å…¥ apiKey / authDomain / projectId / appIdã€‚');
        throw new Error('missing firebaseConfig');
      }
      if (!fbInit) {
        fbInit = (async () => {
          const [
            { initializeApp },
            {
              getAuth,
              onAuthStateChanged,
              signInAnonymously,
              signInWithPopup,
              GoogleAuthProvider,
              signOut
            },
            {
              getFirestore,
              collection,
              doc,
              setDoc,
              getDoc,
              serverTimestamp,
              query,
              orderBy,
              where,
              limit,
              getDocs
            }
          ] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js')
          ]);
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const db = getFirestore(app);
          if (location.protocol === 'https:' && firebaseConfig.measurementId) {
            try {
              const { getAnalytics, isSupported } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js');
              if (await isSupported()) getAnalytics(app);
            } catch (err) {
              console.warn('analytics init skipped', err);
            }
          }
          return {
            app,
            db,
            auth,
            onAuthStateChanged,
            signInAnonymously,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            collection,
            doc,
            setDoc,
            getDoc,
            serverTimestamp,
            query,
            orderBy,
            where,
            limit,
            getDocs
          };
        })();
      }
      return fbInit;
    }

    async function submitScore() {
      const s = store.get();
      const acc = s.total ? Math.round(s.correct / s.total * 100) : 0;
      const ctx = await ensureFirebase();
      let user = ctx.auth.currentUser;
      if (!user) {
        try {
          await ctx.signInAnonymously(ctx.auth);
          user = ctx.auth.currentUser;
        } catch (err) {
          console.error('ç„¡æ³•å–å¾—èªè­‰ä½¿ç”¨è€…', err);
          return;
        }
      }
      const uid = user?.uid;
      if (!uid) return;
      const region = els.region.value;
      const scoreData = {
        uid,
        bestStreak: s.bestStreak || 0,
        accuracy: acc,
        total: s.total || 0,
        region,
        ts: ctx.serverTimestamp()
      };
      await ctx.setDoc(ctx.doc(ctx.db, 'scores', uid), scoreData, { merge: true });
      await ctx.setDoc(ctx.doc(ctx.db, 'scores_region', `${uid}_${region}`), scoreData, { merge: true });
    }

    function renderBoard(globalRows, regionRows, regionKey) {
      const toRow = (row, idx) => {
        const place = idx + 1;
        const name = row.name || (row.uid?.slice(-6) || 'Player');
        return `<div class="item"><span>${place}. ${name}</span><span>é€£å‹ ${row.bestStreak || 0}ï½œæº–ç¢ºç‡ ${row.accuracy || 0}%ï½œé¡Œæ•¸ ${row.total || 0}</span></div>`;
      };
      const globalSection = globalRows.length
        ? globalRows.map(toRow).join('')
        : '<div class="item">ç›®å‰æ²’æœ‰è³‡æ–™</div>';
      const regionLabel = REGION_LABEL[regionKey] || 'ç›®å‰å€åŸŸ';
      const regionSection = regionRows.length
        ? regionRows.map(toRow).join('')
        : '<div class="item">ç›®å‰æ²’æœ‰è³‡æ–™</div>';
      els.boardList.innerHTML = `
        <div class="item"><strong>å…¨çƒæ¦œ</strong></div>
        ${globalSection}
        <div class="item"><strong>${regionLabel}æ¦œ</strong></div>
        ${regionSection}
      `;
    }

    async function openLeaderboard() {
      try {
        const ctx = await ensureFirebase();
        const { db, collection, query, orderBy, where, limit, getDocs } = ctx;
        els.boardList.innerHTML = '<div class="item">è¼‰å…¥ä¸­...</div>';
        els.boardModal.classList.add('show');
        await submitScore();
        const region = els.region.value;
        const globalQ = query(collection(db, 'scores'), orderBy('bestStreak', 'desc'), limit(50));
        const regionQ = query(
          collection(db, 'scores_region'),
          where('region', '==', region),
          orderBy('bestStreak', 'desc'),
          limit(50)
        );
        const [globalSnap, regionSnap] = await Promise.all([getDocs(globalQ), getDocs(regionQ)]);
        const [globalRows, regionRows] = await Promise.all([
          augmentWithNames(ctx, globalSnap.docs.map(d => d.data())),
          augmentWithNames(ctx, regionSnap.docs.map(d => d.data()))
        ]);
        const sorter = (a, b) => {
          if ((b.bestStreak || 0) !== (a.bestStreak || 0)) return (b.bestStreak || 0) - (a.bestStreak || 0);
          return (b.accuracy || 0) - (a.accuracy || 0);
        };
        renderBoard(
          globalRows.sort(sorter).slice(0, 20),
          regionRows.sort(sorter).slice(0, 20),
          region
        );
      } catch (err) {
        console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
        els.boardList.innerHTML = '<div class="item">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      }
    }

    els.board.onclick = () => openLeaderboard();
    els.closeBoard.onclick = () => els.boardModal.classList.remove('show');

    (async () => {
      try {
        const ctx = await ensureFirebase();
        bindAuthUI(ctx);
      } catch (err) {
        console.error('Auth init failed', err);
      }
    })();

    ensureStats(); updateHUD(); nextQuestion();
    addEventListener('keydown', (e) => {
      if (e.key >= '1' && e.key <= '4') {
        const idx = parseInt(e.key, 10) - 1;
        const btn = els.options.children[idx];
        if (btn && !lock) btn.click();
      }
      if (e.key === 'Enter') els.next.click();
    });
  </script>
  </div>
  <!-- éŠæˆ²é é¢çµæŸ -->
</body>
</html>
